<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>OS on lonelyuan's Blog</title><link>https://lonelyuan.github.io/tags/os/</link><description>Recent content in OS on lonelyuan's Blog</description><generator>Hugo -- gohugo.io</generator><language>en</language><lastBuildDate>Fri, 29 Oct 2021 17:03:14 +0000</lastBuildDate><atom:link href="https://lonelyuan.github.io/tags/os/index.xml" rel="self" type="application/rss+xml"/><item><title>MOSPI-ChCore lab (1)</title><link>https://lonelyuan.github.io/p/mospi-chcore-lab-1/</link><pubDate>Fri, 29 Oct 2021 17:03:14 +0000</pubDate><guid>https://lonelyuan.github.io/p/mospi-chcore-lab-1/</guid><description>&lt;p>ç”±äºŽðŸ‘´è§‰å¾—ðŸ‘´å­¦æ ¡çš„æ“ä½œç³»ç»Ÿè®²äº†ä¸ªðŸ”¨ï¼Œæ…•åè€Œæ¥å­¦ä¹ ä¸Šäº¤çš„ MOSPI è¯¾ç¨‹ã€‚é“¶æä¹¦çœ‹å®Œä¹‹åŽðŸ‘´å‘çŽ°ðŸ‘´å­¦æ ¡çš„OSç¡®å®žè®²äº†ä¸ªðŸ”¨ã€‚æˆ‘ç›´æŽ¥å½“åœºæ¥ä¸€æ®µåœ£ç»åŸå”±ï¼š&lt;/p>
&lt;p>é‚£ä¸ªé¢è¥¿ç”µæ“ä½œç³»ç»Ÿå—·ï¼Œä¸ä¼šå†™æ•™æå¯ä»¥ä¸å†™ï¼Œå®³ç‰¹ä¹ˆåœ¨å¼„ä½ é‚£ä¸ªç®¡ç¨‹ï¼Œæ¥æˆ‘æ•™ä½ å•Šï¼Œçœ‹å¥½äº†å•Šã€‚é¦–å…ˆ M.A.L.H. åŽŸåˆ™ï¼Œçœ‹æ‡‚äº†å—ï¼Œç„¶åŽå¼€è®²&lt;strong>è™šæ‹Ÿå†…å­˜&lt;/strong>ï¼Œå“Žæˆ‘å°±ä¸è™šæ‹Ÿï¼Œæˆ‘å°±è®²é‚£ä¸ªç©ºé—²é“¾è¡¨ã€‚å“Žï¼Œå†æ‰Žä¸ª&lt;strong>å¤šçº¿ç¨‹&lt;/strong>ï¼Œçœ‹åˆ°æ²¡ï¼Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢äº†ã€‚æˆ‘ç‰¹ä¹ˆç›´æŽ¥ä¸‰æ®µ&lt;strong>ç³»ç»Ÿè°ƒåº¦&lt;/strong>ï¼ˆçŸ­æœŸï¼Œä¸­æœŸï¼Œé•¿æœŸï¼‰ï¼Œç„¶åŽæˆ‘ç›´æŽ¥~å°±ä¸€ä¸ªå¤šæ ¸è°ƒåº¦ï¼Œæˆ‘å°±è°ƒåº¦åˆ°&lt;strong>IPC&lt;/strong>ï¼Œè¿›ç¨‹çŽ°åœ¨å·²ç»å¯ä»¥é€šä¿¡äº†å•Šï¼åˆ«æ€ªæˆ‘æ²¡æœ‰æ•™å¥½ä½ ï¼Œè¿›ç¨‹é€šä¿¡äº†ä¹‹åŽå¹²ä»€ä¹ˆï¼Œæ†‹ç‰¹ä¹ˆè®²ä½ é‚£ç ´å‡ æŠŠå¤„ç†æœºäº†ã€‚çœ‹å¥½å•Šï¼Œè®²å‡ºé”ï¼ˆå¬‰çš®ç¬‘è„¸ï¼‰ï¼Œè®²å‡º&lt;strong>ä¿¡å·é‡&lt;/strong>ç›´æŽ¥å°±æ‰”åˆ°äº’æ–¥èµ„æºèº«ä¸Šï¼Œå°±ç–¯ç‹‚çš„è¿›å…¥ä»–çš„ä¸´ç•ŒåŒºã€‚ç„¶åŽæˆ‘å†ä¸€ä¸ªï¼Œ&lt;strong>æ–‡ä»¶ç³»ç»Ÿ&lt;/strong>ï¼åŠ ä¸‰æ®µç³»ç»Ÿ&lt;strong>è™šæ‹ŸåŒ–&lt;/strong>ï¼ˆCPUè™šæ‹ŸåŒ–ã€å†…å­˜è™šæ‹ŸåŒ–ã€IOè™šæ‹ŸåŒ–ï¼‰ï¼Œå…¨éƒ¨åƒæ»¡ï¼Œå®Œæˆå¼ºæ€ï¼Œä½ å”›ç’§ä½ æ‡‚ä¸ªderï¼Œè®²å¯„å§OSï¼Œæˆ‘çˆ±ä½ ã€‚&lt;/p>
&lt;p>&lt;em>åœ£ç»åŽŸæ–‡ï¼š&lt;/em>&lt;a class="link" href="https://www.bilibili.com/video/BV1Jf4y1L7EZ" target="_blank" rel="noopener"
>æ‹–æ›´äº‘çš„é¹°ä½æ•™å­¦&lt;/a>&lt;/p>
&lt;hr>
&lt;blockquote>
&lt;p>æœ¬ç³»åˆ—ä¸º ChCore lab å®žéªŒæŠ¥å‘Šã€‚
Labæºç ï¼šhttps://gitee.com/ipads-lab/chcore-lab
MOSPIåœ¨çº¿ç½‘ç«™ï¼šhttps://ipads.se.sjtu.edu.cn/mospi/&lt;/p>
&lt;/blockquote>
&lt;h2 id="å®žéªŒçŽ¯å¢ƒ">å®žéªŒçŽ¯å¢ƒ&lt;/h2>
&lt;p>éœ€è¦dockerå’Œqemuï¼Œdockerä¸èµ˜è¿°ã€‚linuxä¸‹å®‰è£…qemuï¼š
&lt;code>sudo apt-get install qemu-system-arm&lt;/code>
å®‰è£…å®Œæˆä¹‹åŽæŸ¥çœ‹ç‰ˆæœ¬å·ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">$ qemu-system-aarch64 --version
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">QEMU emulator version 4.2.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Copyright (c) 2003-2019 Fabrice Bellard and the QEMU Project developers
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>5ä¸ªå®žéªŒåœ¨æºç ä»“åº“åˆ†åˆ«ä»¥5ä¸ªåˆ†æ”¯å­˜åœ¨ã€‚ git clone -bå³å¯ã€‚&lt;/p>
&lt;p>å†…æ ¸æž„å»ºå’Œè°ƒè¯•ï¼š&lt;/p>
&lt;ul>
&lt;li>ç”¨dockeräº¤å‰ç¼–è¯‘å†…æ ¸ï¼š&lt;code>make build&lt;/code>&lt;/li>
&lt;li>å¯åŠ¨qemuï¼š&lt;code>make qemu&lt;/code>
&lt;ul>
&lt;li>è¿™é‡Œé‡åˆ°æŠ¥é”™ï¼š&lt;code> Unable to init server: Could not connect: Connection refused gtk initialization failed&lt;/code>&lt;/li>
&lt;li>è§£å†³æ–¹æ³•ï¼šä¿®æ”¹ Makefile ï¼Œåœ¨&lt;code>QEMUOPTS&lt;/code>å‚æ•°åŽåŠ &lt;code>-nographic&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>å¯åŠ¨qemuï¼š&lt;code>make qemu-gdb&lt;/code>
&lt;ul>
&lt;li>å°†ç›‘å¬1234ç«¯å£ä»¥ä¾›gdbè¿œç¨‹è°ƒç”¨&lt;/li>
&lt;li>é€€å‡ºï¼š&lt;code>ctrl+a&lt;/code>ï¼Œç„¶åŽæŒ‰xã€‚&lt;/li>
&lt;li>å¦‚æžœæ„å¤–é€€å‡ºï¼Œè¦æ€æ­»è¿›ç¨‹ï¼š&lt;code>kill $(ps -ef | grep qemu | grep 1234 | awk '{print $2}')&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>åœ¨å¦ä¸€ä¸ªç»ˆç«¯å¯åŠ¨gdbè°ƒè¯•ï¼š&lt;code>make gdb&lt;/code>
&lt;ul>
&lt;li>è¿™é‡Œå¯èƒ½éœ€è¦å®‰è£…gdb-multiarchï¼š&lt;code>sudo apt-get install gdb-multiarch&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>å¯ä»¥çœ‹åˆ°ï¼Œæœ¬é¡¹ç›®ä¸­ Makefile ä¸»è¦æ˜¯å°è£…äº†ä¸€äº›å‘½ä»¤ã€‚&lt;/p>
&lt;hr>
&lt;h2 id="lab1">Lab1&lt;/h2>
&lt;h3 id="ç»ƒä¹ 3-åŠ è½½å…¥å£å®šä¹‰">ç»ƒä¹ 3-åŠ è½½å…¥å£å®šä¹‰&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">root@lastyear:~/chcore-lab# readelf -S build/kernel.img
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">There are &lt;span class="m">9&lt;/span> section headers, starting at offset 0x20cd8:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Section Headers:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">[&lt;/span>Nr&lt;span class="o">]&lt;/span> Name Type Address Offset
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Size EntSize Flags Link Info Align
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">[&lt;/span> 0&lt;span class="o">]&lt;/span> NULL &lt;span class="m">0000000000000000&lt;/span> &lt;span class="m">00000000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">0000000000000000&lt;/span> &lt;span class="m">0000000000000000&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">[&lt;/span> 1&lt;span class="o">]&lt;/span> init PROGBITS &lt;span class="m">0000000000080000&lt;/span> &lt;span class="m">00010000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 000000000000b5b0 &lt;span class="m">0000000000000008&lt;/span> WAX &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">4096&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">[&lt;/span> 2&lt;span class="o">]&lt;/span> .text PROGBITS ffffff000008c000 0001c000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 00000000000011dc &lt;span class="m">0000000000000000&lt;/span> AX &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">8&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">[&lt;/span> 3&lt;span class="o">]&lt;/span> .rodata PROGBITS ffffff0000090000 &lt;span class="m">00020000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 00000000000000f8 &lt;span class="m">0000000000000001&lt;/span> AMS &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">8&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">[&lt;/span> 4&lt;span class="o">]&lt;/span> .bss NOBITS ffffff0000090100 000200f8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">0000000000008000&lt;/span> &lt;span class="m">0000000000000000&lt;/span> WA &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">16&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> .comment PROGBITS &lt;span class="m">0000000000000000&lt;/span> 000200f8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">0000000000000032&lt;/span> &lt;span class="m">0000000000000001&lt;/span> MS &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">[&lt;/span> 6&lt;span class="o">]&lt;/span> .symtab SYMTAB &lt;span class="m">0000000000000000&lt;/span> &lt;span class="m">00020130&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">0000000000000858&lt;/span> &lt;span class="m">0000000000000018&lt;/span> &lt;span class="m">7&lt;/span> &lt;span class="m">46&lt;/span> &lt;span class="m">8&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">[&lt;/span> 7&lt;span class="o">]&lt;/span> .strtab STRTAB &lt;span class="m">0000000000000000&lt;/span> &lt;span class="m">00020988&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 000000000000030f &lt;span class="m">0000000000000000&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">[&lt;/span> 8&lt;span class="o">]&lt;/span> .shstrtab STRTAB &lt;span class="m">0000000000000000&lt;/span> 00020c97
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 000000000000003c &lt;span class="m">0000000000000000&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>çœ‹åˆ°initæ®µçš„èµ·å§‹åœ°å€æ˜¯&lt;code>0x80000&lt;/code>ï¼Œå’Œ&lt;code>readelf -h&lt;/code>ä¸­çš„ Entry point address ä¸€è‡´ï¼Œä¹Ÿå’Œ GDB åˆšè¿›å…¥æ—¶&lt;code>where&lt;/code>çš„è¾“å‡ºä¸€è‡´ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">0x0000000000080000 in ?? &lt;span class="o">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>gdb&lt;span class="o">)&lt;/span> where
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#0 0x0000000000080000 in _start ()&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸‹é¢å¯»æ‰¾&lt;code>_start&lt;/code>çš„å®šä¹‰ï¼Œåœ¨&lt;code>CMakeLists.txt&lt;/code>ä¸­æ‰¾åˆ°&lt;code>_start&lt;/code>ï¼Œ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">set_property&lt;span class="o">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> TARGET kernel.img
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> APPEND_STRING
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> PROPERTY
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> LINK_FLAGS
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;-T &lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">CMAKE_CURRENT_BINARY_DIR&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">/&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">link_script&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2"> -e _start&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¿™é‡Œä¸º&lt;code>kernel.img&lt;/code>æŒ‡å®šäº†é“¾æŽ¥å™¨è„šæœ¬(-T)å’Œå…¥å£å‡½æ•°(-e)ã€‚&lt;/p>
&lt;p>äºŽæ˜¯è·Ÿéšlink_scriptï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">set&lt;span class="o">(&lt;/span>link_script &lt;span class="s2">&amp;#34;linker.lds&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">configure_file&lt;span class="o">(&lt;/span>&lt;span class="s2">&amp;#34;./scripts/linker-aarch64.lds.in&amp;#34;&lt;/span> &lt;span class="s2">&amp;#34;linker.lds.S&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¿›å…¥è„šæœ¬linker-aarch64.lds.inï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;#34;../boot/image.h&amp;#34;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">SECTIONS&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">TEXT_OFFSET&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">img_start&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">.;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nl">init&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">$&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="n">init_object&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å…¶ä¸­&lt;code>init&lt;/code>æ®µæŒ‡å®šäº†åŠ è½½&lt;code>init_object&lt;/code>ï¼Œå®ƒè¡¨ç¤ºbootloaderçš„æ‰€æœ‰ç›®æ ‡æ–‡ä»¶é›†åˆã€‚å…¶å®šä¹‰å›žåˆ°&lt;code>CmakeLists.txt&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">set&lt;span class="o">(&lt;/span>init_object
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">BINARY_KERNEL_IMG_PATH&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">/&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">BOOTLOADER_PATH&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">/start.S.o
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">BINARY_KERNEL_IMG_PATH&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">/&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">BOOTLOADER_PATH&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">/mmu.c.o
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">BINARY_KERNEL_IMG_PATH&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">/&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">BOOTLOADER_PATH&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">/tools.S.o
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">BINARY_KERNEL_IMG_PATH&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">/&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">BOOTLOADER_PATH&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">/init_c.c.o
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">BINARY_KERNEL_IMG_PATH&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">/&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">BOOTLOADER_PATH&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">/uart.c.o&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯å‘çŽ°&lt;code>/boot/start.S&lt;/code>å®šä¹‰äº†&lt;code>_start&lt;/code>ã€‚&lt;/p>
&lt;p>ä¸‹é¢ç»§ç»­å¯»æ‰¾åœ°å€ï¼Œåœ¨é“¾æŽ¥å™¨è„šæœ¬å¼•ç”¨äº†&lt;code>image.h&lt;/code>ï¼Œå…¶ä¸­æœ‰&lt;code>TEXT_OFFSET&lt;/code>çš„å®šä¹‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#pragma once
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#define SZ_16K 0x4000
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#define SZ_64K 0x10000
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#define KERNEL_VADDR 0xffffff0000000000
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#define TEXT_OFFSET 0x80000
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸€åˆ‡ç»ˆäºŽä¸²èµ·æ¥äº†ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>CMakeLists.txt&lt;/code>ï¼šæ˜¯CMakeçš„è„šæœ¬æ–‡ä»¶ã€‚ CMake æ˜¯è·¨å¹³å°çš„C/C++å»ºæž„å·¥å…·ã€‚
&lt;ul>
&lt;li>ä½œç”¨ï¼š
&lt;ul>
&lt;li>æŒ‡å®šæºæ–‡ä»¶é›†åˆ&lt;code>init_object&lt;/code>&lt;/li>
&lt;li>å®šä¹‰é“¾æŽ¥å™¨è„šæœ¬&lt;code>link_script&lt;/code>&lt;/li>
&lt;li>æŒ‡å®šå…¥å£å‡½æ•°&lt;code>_start&lt;/code>å¹¶æŒ‡å®šé“¾æŽ¥å™¨è„šæœ¬&lt;/li>
&lt;li>æœ€ç»ˆç”Ÿæˆ&lt;code>kernel.img&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>//æœ€è¿‘çœ‹åˆ°çš„æŒºå¥½çš„CMakeæ•™ç¨‹ï¼šhttps://www.bilibili.com/video/BV1rR4y1E7n9&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;code>linker-aarch64.lds.in&lt;/code>ï¼šldsæ˜¯é“¾æŽ¥å™¨è„šæœ¬æ–‡ä»¶ï¼Œè´Ÿè´£æŽ§åˆ¶è¾“å‡ºçš„ELFæ–‡ä»¶çš„ç»†èŠ‚ã€‚
&lt;ul>
&lt;li>ä½œç”¨ï¼šæŒ‡å®šäº†èµ·å§‹åœ°å€&lt;code>0x80000&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="ç»ƒä¹ 3-å¤šå¤„ç†å™¨æŒ‚èµ·">ç»ƒä¹ 3-å¤šå¤„ç†å™¨æŒ‚èµ·&lt;/h3>
&lt;p>&lt;code>start.S&lt;/code>ä¸­æ³¨é‡Šçš„å¾ˆæ˜Žç™½äº†ï¼Œé€šè¿‡æ£€æŸ¥&lt;code>mpidr_el1&lt;/code>å¯„å­˜å™¨æ¥åˆ¤æ–­ cpuid ï¼Œå¦‚æžœä¸æ˜¯0åˆ™è¿›å…¥æ­»å¾ªçŽ¯ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="nf">BEGIN_FUNC&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">_start&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">mrs&lt;/span> &lt;span class="n">x8&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">mpidr_el1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">and&lt;/span> &lt;span class="n">x8&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x8&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="err">#&lt;/span>&lt;span class="mh">0xFF&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">cbz&lt;/span> &lt;span class="n">x8&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">primary&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="cm">/* hang all secondary processors before we intorduce multi-processors */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nl">secondary_hang&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">bl&lt;/span> &lt;span class="n">secondary_hang&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nl">primary&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="cm">/* Turn to el1 from other exception levels. */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">bl&lt;/span> &lt;span class="n">arm64_elX_to_el1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="cm">/* Prepare stack pointer and jump to C. */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">adr&lt;/span> &lt;span class="n">x0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">boot_cpu_stack&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">add&lt;/span> &lt;span class="n">x0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="err">#&lt;/span>&lt;span class="mh">0x1000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">mov&lt;/span> &lt;span class="n">sp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">bl&lt;/span> &lt;span class="n">init_c&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="cm">/* Should never be here */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">b&lt;/span> &lt;span class="p">.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">END_FUNC&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">_start&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="ç»ƒä¹ 4-lmaå’Œvma">ç»ƒä¹ 4-LMAå’ŒVMA&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">root@lastyear:~/chcore-lab# objdump -h build/kernel.img
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">build/kernel.img: file format elf64-little
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sections:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Idx Name Size VMA LMA File off Algn
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">0&lt;/span> init 0000b5b0 &lt;span class="m">0000000000080000&lt;/span> &lt;span class="m">0000000000080000&lt;/span> &lt;span class="m">00010000&lt;/span> 2**12
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> CONTENTS, ALLOC, LOAD, CODE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">1&lt;/span> .text 000011dc ffffff000008c000 000000000008c000 0001c000 2**3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> CONTENTS, ALLOC, LOAD, READONLY, CODE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">2&lt;/span> .rodata 000000f8 ffffff0000090000 &lt;span class="m">0000000000090000&lt;/span> &lt;span class="m">00020000&lt;/span> 2**3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> CONTENTS, ALLOC, LOAD, READONLY, DATA
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">3&lt;/span> .bss &lt;span class="m">00008000&lt;/span> ffffff0000090100 &lt;span class="m">0000000000090100&lt;/span> 000200f8 2**4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ALLOC
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">4&lt;/span> .comment &lt;span class="m">00000032&lt;/span> &lt;span class="m">0000000000000000&lt;/span> &lt;span class="m">0000000000000000&lt;/span> 000200f8 2**0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> CONTENTS, READONLY
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯ä»¥å‘çŽ°åªæœ‰initæ®µçš„VMAå’ŒLMAç›¸åŒã€‚å…¶èµ‹å€¼è¿˜æ˜¯å›žåˆ°ldsè„šæœ¬ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="n">SECTIONS&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">TEXT_OFFSET&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">img_start&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">.;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nl">init&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">//initæ®µVMA==VMA
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="err">$&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="n">init_object&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nf">ALIGN&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">SZ_16K&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// å¯¹é½16k
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">init_end&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nf">ABSOLUTE&lt;/span>&lt;span class="p">(.);&lt;/span> &lt;span class="c1">// initæ®µç»“æŸ
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// KERNEL_VADDRåœ¨image.hå®šä¹‰ä¸º0xffffff0000000000
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">.&lt;/span>&lt;span class="n">text&lt;/span> &lt;span class="n">KERNEL_VADDR&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nl">init_end&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="nf">AT&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">init_end&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// ATæŒ‡å®šLMA
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">(.&lt;/span>&lt;span class="n">text&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="c1">// .textæ®µï¼šVMA = KERNEL_VADDR + init_end; LMA = init_end
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// åŽé¢çš„æ®µï¼Œå…¨éƒ¨æŒ‰é¡ºåºå¯¹é½å¹¶é€’å¢žï¼Œæ­¤æ—¶VMAå’ŒLMAå·²ç»ä¸åŒï¼Œæ•…åŽé¢çš„æ®µä¹Ÿå…¨éƒ½ä¸åŒ
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">.&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nf">ALIGN&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">SZ_64K&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.&lt;/span>&lt;span class="nl">data&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">*&lt;/span>&lt;span class="p">(.&lt;/span>&lt;span class="n">data&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nf">ALIGN&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">SZ_64K&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.&lt;/span>&lt;span class="nl">rodata&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">*&lt;/span>&lt;span class="p">(.&lt;/span>&lt;span class="n">rodata&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">_edata&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">.&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">KERNEL_VADDR&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// è¿™äº›å¤–éƒ¨å˜é‡æŒ‡çš„æ˜¯LMAï¼Œåˆ™å‡åŽ»è™šæ‹Ÿåœ°å€å¤´
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">_bss_start&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">.&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">KERNEL_VADDR&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.&lt;/span>&lt;span class="nl">bss&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">*&lt;/span>&lt;span class="p">(.&lt;/span>&lt;span class="n">bss&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">_bss_end&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">.&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">KERNEL_VADDR&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nf">ALIGN&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">SZ_64K&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">img_end&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">.&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">KERNEL_VADDR&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å›žç­”é—®é¢˜ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>ä¸ºä»€ä¹ˆLMAå’ŒVMAä¸åŒ&lt;/p>
&lt;ul>
&lt;li>VMAæ˜¯å¯¹åº”è™šæ‹Ÿå†…å­˜çš„åœ°å€ï¼Œä½†åœ¨å†…æ ¸å¯åŠ¨æ—¶è¿˜å¤„äºŽç‰©ç†åœ°å€æ¨¡å¼ï¼ŒVMAå¯èƒ½è¶…å‡ºç‰©ç†å†…å­˜èŒƒå›´ã€‚æ‰€ä»¥åªèƒ½å…ˆåŠ è½½ï¼Œå†æ˜ å°„åˆ°è™šæ‹Ÿåœ°å€ã€‚&lt;/li>
&lt;li>ä¸ºä»€ä¹ˆå†…æ ¸æ®µçš„VMAè¦æ˜ å°„åˆ°é«˜ä½ï¼Œåº”è¯¥æ˜¯ä¸€ç§æƒ¯ä¾‹ã€‚&lt;/li>
&lt;li>ä¸ºä»€ä¹ˆbootloaderä¸ç”¨VMAï¼Œå› ä¸ºä»–è´Ÿè´£åˆå§‹åŒ–é¡µè¡¨ï¼Œä»–ä¸èƒ½ç”¨ï¼Œä¹Ÿæ²¡æœ‰å¿…è¦ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>LMAåˆ°VMAåœ¨ä½•æ—¶è½¬æ¢&lt;/p>
&lt;ul>
&lt;li>ç”±ä¸Šä¸€é—®å¯çŸ¥ï¼Œé¡µè¡¨åˆå§‹åŒ–ä¹‹åŽä¾¿å¯è½¬æ¢ä¸ºVMAã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="ç»ƒä¹ 5-cè¯­è¨€è¿›åˆ¶è½¬æ¢">ç»ƒä¹ 5-cè¯­è¨€è¿›åˆ¶è½¬æ¢&lt;/h3>
&lt;p>ä»ŽåŽå¾€å‰å–ä½™å³å¯ã€‚&lt;/p>
&lt;h3 id="ç»ƒä¹ 6-å‡½æ•°æ ˆ">ç»ƒä¹ 6-å‡½æ•°æ ˆ&lt;/h3>
&lt;p>&lt;code>start.S&lt;/code>ä¸­èµ‹å€¼äº†spï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"> /* Prepare stack pointer and jump to C. */
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> adr x0, boot_cpu_stack
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> add x0, x0, #0x1000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mov sp, x0 /* sp = boot_cpu_stack + 0x1000 */
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>boot_cpu_stack&lt;/code>åœ¨&lt;code>init.c&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#define INIT_STACK_SIZE 0x1000
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="n">boot_cpu_stack&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">PLAT_CPU_NUMBER&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">INIT_STACK_SIZE&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="nf">ALIGN&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">16&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç”±äºŽ&lt;code>PLAT_CPU_NUMBER&lt;/code>è¢«å®šä¹‰ä¸º4ï¼Œæ•…&lt;code>boot_cpu_stack&lt;/code>å¤§å°ä¸º4*4096ï¼Œå¯ä¾›å››ä¸ªCPUä½¿ç”¨ã€‚spåˆå§‹åŒ–åŽæŒ‡å‘ç¬¬ä¸€ä¸ª4069ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªcpuå†…æ ¸æ ˆçš„æœ€é«˜ä½ã€‚åˆå§‹åŒ–æ—¶ï¼Œfp=spã€‚&lt;/p>
&lt;p>ä½†è¿™æ˜¯bootloaderçš„æ ˆã€‚åŽç»­è¿›å…¥å†…æ ¸åŽï¼Œä¼šé‡æ–°åˆ†é…å†…æ ¸æ ˆï¼Œå‚è§&lt;code>head.S&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">BEGIN_FUNC(start_kernel)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mov x3, #0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> msr TPIDR_EL1, x3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ldr x2, =kernel_stack
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> add x2, x2, KERNEL_STACK_SIZE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mov sp, x2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> bl main
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">END_FUNC(start_kernel)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>äºŽæ˜¯å†…æ ¸æ ˆçš„å®šä¹‰åœ¨start_kernelå‡½æ•°ã€‚&lt;/p>
&lt;p>æœ‰å…³å†…æ ¸æ ˆçš„ä½ç½®ï¼Œå› ä¸ºkernel_stackæ˜¯å…¨å±€æ•°ç»„ï¼Œä¸”æœªåˆå§‹åŒ–ï¼Œå› è€Œä½äºŽ.bssã€‚åŒæ—¶æ²¡æœ‰å…¶ä»–æœªåˆå§‹åŒ–å˜é‡ï¼Œå› æ­¤é¦–åœ°å€åœ¨&lt;code>.bss + KERNEL_STACK_SIZE&lt;/code>ã€‚&lt;/p>
&lt;p>é€šè¿‡readelfå¾—åˆ°.bssçš„VMAä¸º0xffffff0000090100ï¼ŒKERNEL_STACK_SIZEä¸º0x2000ï¼Œè¿›å…¥gdbè°ƒè¯•å¯ä»¥éªŒè¯&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">gefâž¤ x/g $sp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">0xffffff0000092100 &amp;lt;kernel_stack+8192&amp;gt;: 0x0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="ç»ƒä¹ 7-è°ƒç”¨æƒ¯ä¾‹">ç»ƒä¹ 7-è°ƒç”¨æƒ¯ä¾‹&lt;/h3>
&lt;p>å…ˆçœ‹stack_testå‡½æ•°ã€‚è¿™é‡Œgdbå®‰è£…äº†gefæ’ä»¶ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">gefâž¤ b stack_test
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Breakpoint 1 at 0xffffff000008c020
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gefâž¤ disas
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dump of assembler code for function stack_test:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">=&amp;gt; 0xffffff000008c020 &amp;lt;+0&amp;gt;: stp x29, x30, [sp, #-32]! /* FPã€LR å…¥æ ˆ */
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0xffffff000008c024 &amp;lt;+4&amp;gt;: mov x29, sp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0xffffff000008c028 &amp;lt;+8&amp;gt;: str x19, [sp, #16] /* x å…¥æ ˆ */
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0xffffff000008c02c &amp;lt;+12&amp;gt;: mov x19, x0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0xffffff000008c030 &amp;lt;+16&amp;gt;: mov x1, x0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0xffffff000008c034 &amp;lt;+20&amp;gt;: adrp x0, 0xffffff0000090000 # è®¡ç®—åç§»
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0xffffff000008c038 &amp;lt;+24&amp;gt;: add x0, x0, #0x0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0xffffff000008c03c &amp;lt;+28&amp;gt;: bl 0xffffff000008c620 &amp;lt;printk&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0xffffff000008c040 &amp;lt;+32&amp;gt;: cmp x19, #0x0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0xffffff000008c044 &amp;lt;+36&amp;gt;: b.gt 0xffffff000008c068 &amp;lt;stack_test+72&amp;gt; # greater than /* é€’å½’ */
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0xffffff000008c048 &amp;lt;+40&amp;gt;: bl 0xffffff000008c0dc &amp;lt;stack_backtrace&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0xffffff000008c04c &amp;lt;+44&amp;gt;: mov x1, x19
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0xffffff000008c050 &amp;lt;+48&amp;gt;: adrp x0, 0xffffff0000090000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0xffffff000008c054 &amp;lt;+52&amp;gt;: add x0, x0, #0x20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0xffffff000008c058 &amp;lt;+56&amp;gt;: bl 0xffffff000008c620 &amp;lt;printk&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0xffffff000008c05c &amp;lt;+60&amp;gt;: ldr x19, [sp, #16] # x19 = sp + 16 /* x å‡ºæ ˆ */
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0xffffff000008c060 &amp;lt;+64&amp;gt;: ldp x29, x30, [sp], #32 # load pair /* FPã€LR å‡ºæ ˆ */
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0xffffff000008c064 &amp;lt;+68&amp;gt;: ret
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0xffffff000008c068 &amp;lt;+72&amp;gt;: sub x0, x19, #0x1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0xffffff000008c06c &amp;lt;+76&amp;gt;: bl 0xffffff000008c020 &amp;lt;stack_test&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0xffffff000008c070 &amp;lt;+80&amp;gt;: mov x1, x19
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0xffffff000008c074 &amp;lt;+84&amp;gt;: adrp x0, 0xffffff0000090000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0xffffff000008c078 &amp;lt;+88&amp;gt;: add x0, x0, #0x20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0xffffff000008c07c &amp;lt;+92&amp;gt;: bl 0xffffff000008c620 &amp;lt;printk&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0xffffff000008c080 &amp;lt;+96&amp;gt;: ldr x19, [sp, #16]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0xffffff000008c084 &amp;lt;+100&amp;gt;: ldp x29, x30, [sp], #32
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0xffffff000008c088 &amp;lt;+104&amp;gt;: ret
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">End of assembler dump.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¿è¡Œï¼Œè§‚å¯Ÿæ ˆçš„å˜åŒ–ï¼Œè¿™é‡Œçœç•¥éƒ¨åˆ†è¾“å‡ºï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">gefâž¤ c
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ registers â”€â”€â”€â”€
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$x0 : 0x0000000000000005 # è¿™ä¸€å±‚å‡½æ•°çš„è¾“å…¥å€¼
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$x19 : 0x0000000000000000 # ä¸Šä¸€å±‚å‡½æ•°çš„è¿”å›žå€¼
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$x29 : 0xffffff00000920f0 # FP
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$x30 : 0xffffff000008c0d4 â†’ &amp;lt;main+72&amp;gt; # LR
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$sp : 0xffffff00000920f0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ stack â”€â”€â”€â”€
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">0xffffff00000920f0â”‚+0x0000: 0x0000000000000000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">0xffffff00000920f8â”‚+0x0008: 0xffffff000008c018 # æ ˆå¤´ï¼Œå¯èƒ½æ˜¯æ ˆåˆå§‹åŒ–çš„æ•°æ®ç»“æž„
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ trace â”€â”€â”€â”€
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">[#0] 0xffffff000008c020 â†’ stack_test()
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">[#1] 0xffffff000008c0d4 â†’ main()
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gefâž¤ c
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ registers â”€â”€â”€â”€
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$x0 : 0x0000000000000004
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$x19 : 0x0000000000000005
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$x29 : 0xffffff00000920d0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$x30 : 0xffffff000008c070 #â†’ &amp;lt;stack_test+80&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$sp : 0xffffff00000920d0 â†’ 0xffffff00000920f0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ stack â”€â”€â”€â”€
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">0xffffff00000920d0â”‚+0x0000: 0xffffff00000920f0 â”€â” # FP
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">0xffffff00000920d8â”‚+0x0008: 0xffffff000008c0d4 â”‚ # LR
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">0xffffff00000920e0â”‚+0x0010: 0x0000000000000000 â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">0xffffff00000920e8â”‚+0x0018: 0x00000000ffffffc0 â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">0xffffff00000920f0â”‚+0x0020: 0x0000000000000000 â—„â”˜
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">0xffffff00000920f8â”‚+0x0028: 0xffffff000008c018
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ trace â”€â”€â”€â”€
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">[#0] 0xffffff000008c020 â†’ stack_test()
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">[#1] 0xffffff000008c070 â†’ stack_test()
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">[#2] 0xffffff000008c0d4 â†’ main()
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gefâž¤ c
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ registers â”€â”€â”€â”€
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$x0 : 0x0000000000000003
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$x19 : 0x0000000000000004
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$x29 : 0xffffff00000920b0 â†’ 0xffffff00000920d0 â†’ 0xffffff00000920f0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$x30 : 0xffffff000008c070
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$sp : 0xffffff00000920b0 â†’ 0xffffff00000920d0 â†’ 0xffffff00000920f0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ stack â”€â”€â”€â”€
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">0xffffff00000920b0â”‚+0x0000: 0xffffff00000920d0 â”€â” # [#1]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">0xffffff00000920b8â”‚+0x0008: 0xffffff000008c070 â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">0xffffff00000920c0â”‚+0x0010: 0x0000000000000005 â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">0xffffff00000920c8â”‚+0x0018: 0x00000000ffffffc0 â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">0xffffff00000920d0â”‚+0x0020: 0xffffff00000920f0 â—„â”˜ # [#2]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">0xffffff00000920d8â”‚+0x0028: 0xffffff000008c0d4 â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">0xffffff00000920e0â”‚+0x0010: 0x0000000000000000 â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">0xffffff00000920e8â”‚+0x0018: 0x00000000ffffffc0 â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">0xffffff00000920f0â”‚+0x0020: 0x0000000000000000 â—„â”˜ # [#3]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">0xffffff00000920f8â”‚+0x0028: 0xffffff000008c018
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ trace â”€â”€â”€â”€
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">[#0] 0xffffff000008c020 â†’ stack_test()
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">[#1] 0xffffff000008c070 â†’ stack_test()
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">[#2] 0xffffff000008c070 â†’ stack_test()
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">[#3] 0xffffff000008c0d4 â†’ main()
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°æ¯æ¬¡é€’å½’è°ƒç”¨åŽ‹æ ˆ4ä¸ª64ä½å­—ï¼Œåˆ†åˆ«æ˜¯ï¼šä¸Šä¸€å±‚FPï¼ŒLRï¼Œå‚æ•°xå’Œ0x00000000ffffffc0ã€‚æœ€åŽä¸€ä¸ª64ä½å­—ç”¨é€”æœªçŸ¥ã€‚&lt;/p>
&lt;h3 id="ç»ƒä¹ 9-backtrace">ç»ƒä¹ 9-backtrace&lt;/h3>
&lt;p>æä¾›&lt;code>read_fp()&lt;/code>æŽ¥å£ï¼Œæˆ‘ä»¬çŸ¥é“fpæ°¸è¿œæŒ‡å‘çˆ¶å‡½æ•°çš„fpï¼Œæ•…é€’å½’è°ƒç”¨å³å¯ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl"> &lt;span class="n">u64&lt;/span>&lt;span class="o">*&lt;/span> &lt;span class="n">fp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">u64&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">u64&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="nf">read_fp&lt;/span>&lt;span class="p">());&lt;/span> &lt;span class="c1">// åŒå±‚æŒ‡é’ˆï¼Œå› ä¸ºç¬¬ä¸€å±‚æ˜¯æœ¬å‡½æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">while&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">printk&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;LR %lx FP %lx Args %d %d %d %d %d&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">fp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">));&lt;/span> &lt;span class="c1">//ä¸ºä»€ä¹ˆ5ä¸ªå‚æ•°æ˜¯fp-2åˆ°fp+2ï¼Ÿæ ·ä¾‹åªåŒ…æ‹¬ä¸€ä¸ªå‚æ•°ï¼Œåªè¦å‡ºçŽ°fp+2å°±èƒ½æµ‹è¯•é€šè¿‡
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">fp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">u64&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//ä¸‹ä¸€å±‚
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ»¡åˆ†é€šè¿‡ï¼Œæ‡’å¾—è´´å›¾äº†ã€‚&lt;/p>
&lt;hr>
&lt;p>çœ‹åˆ°å¤§ä½¬å†™çš„ï¼Œçž¬é—´ä¸æƒ³å†™äº†ï¼Œå¯„ã€‚
&lt;a class="link" href="https://www.cnblogs.com/kangyupl/p/chcore_lab1.html" target="_blank" rel="noopener"
>https://www.cnblogs.com/kangyupl/p/chcore_lab1.html&lt;/a>&lt;/p></description></item></channel></rss>