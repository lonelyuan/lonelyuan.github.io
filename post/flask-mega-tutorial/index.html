<html>
<head>
    <meta charset="utf-8" />
<meta name="description" content="" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>å¹´è½»äººçš„ç¬¬äºŒä¸ªç½‘ç«™ - The Flask Mega Tutorial | lonelyuan&#39;s Blog</title>

<link rel="shortcut icon" href="https://lonelyuan.github.io/favicon.ico?v=1636619068159">

<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://lonelyuan.github.io/styles/main.css">
<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css"> -->

<style>
    hr {
        margin-top: 1rem;
        margin-bottom: 1rem;
        border: 0;
        border-top: 1px solid rgba(0, 0, 0, 0.1);
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets/highlight.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dockerfile.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dart.min.js"></script>

<!-- <script src="https://cdn.jsdelivr.net/npm/moment@2.27.0/moment.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.min.js"></script> -->
<!-- DEMO JS -->
<!--<script src="media/scripts/index.js"></script>-->


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.css">
</head>
<body>
<div class="main gt-bg-theme-color-first">
    <style>
    /* å¯¼èˆªæ æ ·å¼ */
    .navbar {
        position: relative;
        display: -ms-flexbox;
        display: flex;
        -ms-flex-wrap: wrap;
        flex-wrap: wrap;
        -ms-flex-align: center;
        align-items: center;
        -ms-flex-pack: justify;
        justify-content: space-between;
        padding: 0.5rem 1rem;
    }

    .navbar-brand {
        display: inline-block;
        padding-top: 0.3125rem;
        padding-bottom: 0.3125rem;
        margin-right: 1rem;
        font-size: 1.25rem;
        line-height: inherit;
        white-space: nowrap;
    }

    .navbar-brand:hover,
    .navbar-brand:focus {
        text-decoration: none;
    }

    .navbar-nav {
        display: -ms-flexbox;
        display: flex;
        -ms-flex-direction: column;
        flex-direction: column;
        padding-left: 0;
        margin-bottom: 0;
        list-style: none;
    }

    .navbar-collapse {
        -ms-flex-preferred-size: 100%;
        flex-basis: 100%;
        -ms-flex-positive: 1;
        flex-grow: 1;
        -ms-flex-align: center;
        align-items: center;
    }

    .navbar-toggler {
        padding: 0.25rem 0.75rem;
        font-size: 1.25rem;
        line-height: 1;
        background-color: transparent;
        border: 1px solid transparent;
        border-radius: 0.25rem;
    }

    .navbar-toggler:hover,
    .navbar-toggler:focus {
        text-decoration: none;
    }

    @media (min-width: 992px) {
        .navbar-expand-lg {
            -ms-flex-flow: row nowrap;
            flex-flow: row nowrap;
            -ms-flex-pack: start;
            justify-content: flex-start;
        }

        .navbar-expand-lg .navbar-nav {
            -ms-flex-direction: row;
            flex-direction: row;
        }

        .navbar-expand-lg .navbar-collapse {
            display: -ms-flexbox !important;
            display: flex !important;
            -ms-flex-preferred-size: auto;
            flex-basis: auto;
        }

        .navbar-expand-lg .navbar-toggler {
            display: none;
        }
    }

    @media (max-width: 991px) {
        #navbarSupportedContent {
            display: none;
        }
    }
</style>
<nav class="navbar navbar-expand-lg">
    <div class="navbar-brand">
        <img class="user-avatar" src="/images/avatar.png" alt="å¤´åƒ">
        <div class="site-name gt-c-content-color-first">
            lonelyuan&#39;s Blog
        </div>
    </div>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <i class="fas fa-bars gt-c-content-color-first" style="font-size: 18px"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <div class="navbar-nav mr-auto" style="text-align: center">
            
            <div class="nav-item">
                
                <a href="/" class="menu gt-a-link">
                    é¦–é¡µ
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/tag/Oi-EjtG-8Z/" class="menu gt-a-link">
                    CTF
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/tag/Lz-SvRH-s/" class="menu gt-a-link">
                    CS
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/archives" class="menu gt-a-link">
                    å½’æ¡£
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/tags" class="menu gt-a-link">
                    æ ‡ç­¾
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="https://lonelyuan.github.io/post/about" class="menu gt-a-link">
                    å…³äº
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="https://lonelyuan.github.io/friends" class="menu gt-a-link">
                    å‹é“¾
                </a>
                
            </div>
            
        </div>
        <div style="text-align: center">
            <form id="gridea-search-form" style="position: relative" data-update="1636619068159"
                action="/search/index.html">
                <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="æœç´¢æ–‡ç« " />
                <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
        </div>
    </div>
</nav>
<script>
    /* ç§»åŠ¨ç«¯å¯¼èˆªæ å±•å¼€/æ”¶èµ·åˆ‡æ¢ */
    document.getElementById('changeNavbar').onclick = function () {
        var element = document.getElementById('navbarSupportedContent');
        if (element.style.display === 'none' || element.style.display === '') {
            element.style.display = 'block';
        } else {
            element.style.display = 'none';
        }
    }
</script>
    <div class="post-container">
        <div class="post-detail gt-bg-theme-color-second">
            <article class="gt-post-content">
                <h2 class="post-title">
                    å¹´è½»äººçš„ç¬¬äºŒä¸ªç½‘ç«™ - The Flask Mega Tutorial
                </h2>
                <div class="post-info">
                    <time class="post-time gt-c-content-color-first">
                        Â· 2021-09-09 Â·
                    </time>
                    
                        <a href="https://lonelyuan.github.io/tag/t1NEIiGto/" class="post-tags">
                            # Web
                        </a>
                    
                </div>
                <div class="post-content">
                    <blockquote>
<p>æœ¬æ–‡ä¸º Flask æ¡†æ¶å­¦ä¹ ç¬”è®°ï¼Œä¸»è¦å‚è€ƒäº† <a href="https://luhuisicnu.gitbook.io/the-flask-mega-tutorial-zh">The-Flask-Mega-Tutorial</a> å’Œ ã€ŠFlask Webå¼€å‘ï¼šåŸºäºPythonçš„Webåº”ç”¨å¼€å‘å®æˆ˜ã€‹ä¸¤æœ¬ä¹¦ï¼Œå¹¶åœ¨åŸé¡¹ç›®çš„åŸºç¡€ä¸Šæ‹“å±•ã€‚ï¼ˆä¸‹æ–‡ç»Ÿç§°è¿™ä¸¤ä¸ªèµ„æºä¸ºâ€œæœ¬æ•™ç¨‹â€ï¼‰<br>
ä¸ç†Ÿæ‚‰ Flask æ¡†æ¶è¯·å…ˆé˜…è¯»<a href="https://dormousehole.readthedocs.io/en/latest/quickstart.html">å¿«é€Ÿä¸Šæ‰‹ - flask ä¸­æ–‡æ–‡æ¡£</a> ã€‚</p>
<p>è¿™ä¸¤æœ¬ä¹¦çš„ä½œè€…æ˜¯åŒä¸€ä¸ªäººï¼Œå°±å†…å®¹ä¸Šè¯´åè€…ç®—æ˜¯å‰è€…çš„è±ªåç‰ˆã€‚æœ¬æ•™ç¨‹çš„ä¼˜ç‚¹æ˜¯å†…å®¹å…¨é¢ï¼Œä»å…¥é—¨åˆ°éƒ¨ç½²ä¸€ç«™å¼æœåŠ¡ï¼›ç¼ºç‚¹æ˜¯ä¸å¤Ÿæ·±å…¥ï¼Œä¸”æœ‰äº›è¿‡æ—¶ï¼Œä¹¦ä¸­ä¸¾ä¾‹çš„è¯¸å¤šæ’ä»¶å‡ä¸ºä½œè€…ä¸ºäº†æ­¤ä¹¦è€Œå¼€å‘çš„ï¼Œå·²ç»è®¸ä¹…ä¸å†ç»´æŠ¤ï¼Œå¯¼è‡´å¾ˆéš¾åœ¨å…¶ç¤ºä¾‹é¡¹ç›®ä¸Šæ‹“å±•ã€‚ä¸€çœ‹æ‰‰é¡µï¼Œ2015å¹´å‡ºç‰ˆï¼Œé‚£æ²¡äº‹äº†ã€‚<br>
è‡³äºç¬¬ä¸€ä¸ªç½‘ç«™ï¼Ÿå‚è§<a href="#%E6%88%91%E8%BF%98%E6%B2%A1%E5%86%99%E5%91%A2">#TODO:å¹´è½»äººçš„ç¬¬ä¸€ä¸ªç½‘ç«™</a></p>
</blockquote>
<hr>
<h2 id="0x00-å¤§å‹é¡¹ç›®ç»“æ„">0x00 å¤§å‹é¡¹ç›®ç»“æ„</h2>
<p>åœ¨å¤§éƒ¨åˆ†é¢å‘åˆå­¦è€…çš„ demo ä¸­ï¼Œåº”ç”¨ä»¥ç®€å•çš„é¡¹ç›®ç»“æ„ç”šè‡³å•æ–‡ä»¶è¡¨ç¤ºã€‚åœ¨å¤§å‹é¡¹ç›®ä¸­ï¼Œç½‘ç«™çš„ä¸åŒåŠŸèƒ½è¢«æ‹†åˆ†æˆç‹¬ç«‹çš„æ¨¡å—ï¼Œä»¥æ–¹ä¾¿æ‹“å±•å’Œç»´æŠ¤ã€‚ä¸€ä¸ªæ›´é€šç”¨çš„ Flask é¡¹ç›®ä»£ç æ¶æ„å¦‚ä¸‹ï¼šï¼ˆä»…è€ƒè™‘ä¸šåŠ¡ä»£ç ï¼‰</p>
<pre><code>microblog/ # æ ¹ç›®å½•
  app/ # é¡¹ç›®æºç 
    __init__.py # é¡¹ç›®åˆå§‹åŒ–ï¼Œå½“è¯¥åŒ…è¢«importï¼Œé¦–å…ˆæ‰§è¡Œ__init__.py
    routes.py
    forms.py
    ...
  main.py # æ¡†æ¶å…¥å£
  config.py # Configé…ç½®ç±»
  .flaskenv
  ...
</code></pre>
<p>æ ¹ç›®å½•ä¸‹çš„æ–‡ä»¶æœ‰ï¼š</p>
<ul>
<li><code>app/</code>æ‰€æœ‰ç½‘ç«™æºä»£ç ç»Ÿä¸€å½’åˆ°appç›®å½•ä¸‹ã€‚
<ul>
<li>åœ¨<code>app/</code>å†…éƒ¨ï¼Œä¸åŒçš„åŠŸèƒ½å¯è¿›ä¸€æ­¥åˆ’åˆ†æˆç‹¬ç«‹æ¨¡å—ï¼Œè¯¦è§[æ¨¡å—åŒ–åº”ç”¨](#0x05 æ¨¡å—åŒ–åº”ç”¨ï¼šåŠŸèƒ½è§£è€¦)ä¸€ç« ã€‚</li>
</ul>
</li>
<li><code>main.py</code>: å…¥å£è„šæœ¬ï¼Œé€šè¿‡è¯¥æ–‡ä»¶å¼•å…¥appä¸­çš„ä»£ç å¹¶ç”Ÿæˆåº”ç”¨å®ä¾‹ï¼ˆå‘½åéšæ„ï¼‰</li>
<li><code>.flaskenv</code>: flaskç¯å¢ƒå˜é‡ï¼Œä»¥é…åˆflaskå‘½ä»¤ã€‚å…¥å£è„šæœ¬è¢«å®šä¹‰ä¸º<code>FLASK_APP</code>ï¼Œæ‰§è¡Œ<code>flask run</code>æ—¶å°†å¯åŠ¨è¯¥è„šæœ¬ã€‚</li>
<li><code>config.py</code>: é…ç½®è„šæœ¬ï¼Œæ•´ä¸ªé¡¹ç›®çš„é…ç½®ä¿¡æ¯éƒ½å†™åœ¨Configç±»é‡Œã€‚ä¸ç¯å¢ƒå˜é‡çš„åŒºåˆ«åœ¨äºï¼Œå› ä¸ºæ˜¯pythonè„šæœ¬ï¼ŒåŠŸèƒ½æ›´å¼ºå¤§ï¼Œå¯è¢«ä»»ä½•åœ°æ–¹çš„ä»£ç å¼•ç”¨ã€‚</li>
</ul>
<h2 id="0x01-hello-worldæ¨¡æ¿å’Œè§†å›¾">0x01 Hello worldï¼šæ¨¡æ¿å’Œè§†å›¾</h2>
<p>æœ€åŸºæœ¬çš„ web åŠŸèƒ½ï¼Œæ— éæ¥å—è¯·æ±‚ã€è¿”å›æ•°æ®ã€‚å…¶ä¸­ï¼Œè·¯ç”± (route) ç”¨æ¥åŒºåˆ†ä¸åŒçš„è¯·æ±‚ï¼Œæ¨¡æ¿ (templates) ç”¨æ¥ç”Ÿæˆä¸åŒçš„æ•°æ®ã€‚</p>
<h4 id="è·¯ç”±è§†å›¾">è·¯ç”±/è§†å›¾</h4>
<p>åœ¨éå‰åç«¯åˆ†ç¦»çš„é¡¹ç›®ä¸­ï¼Œè§†å›¾å‡½æ•°ç›´æ¥è¿”å›æ¸²æŸ“å¥½çš„ç½‘é¡µï¼Œç”±<code>@app.route()</code>ä¿®é¥°åï¼Œè§†å›¾å’Œè·¯ç”±ä¾¿ç»‘å®šåœ¨ä¸€èµ·ã€‚<br>
åœ¨mvcæ¨¡å‹ä¸­æ›´åƒcontrolleræ§åˆ¶å™¨çš„è§’è‰²ï¼Œç„¶è€Œåœ¨flaskç”Ÿæ€ä¸­æ›´å–œæ¬¢ç§°ä¸ºè§†å›¾å‡½æ•°ã€‚</p>
<ul>
<li><code>url_for()</code> ä½¿ç”¨URLåˆ°è§†å›¾å‡½æ•°çš„å†…éƒ¨æ˜ å°„å…³ç³»æ¥ç”ŸæˆURLï¼Œç”¨æ¥æ›¿æ¢ç¡¬é“¾æ¥ã€‚åœ¨ä¸šåŠ¡åŠŸèƒ½è§£è€¦åå¿…é¡»ä½¿ç”¨è¿™ç§æ–¹å¼ã€‚
<ul>
<li>NOTEï¼šå½“è·¯ç”±å’Œè§†å›¾å‡½æ•°åä¸ä¸€è‡´ï¼Œè®¿é—®è¯¥è·¯ç”±å¯ä»¥æ­£ç¡®å“åº”ï¼Œä½†æ˜¯ä½¿ç”¨<code>url_for()</code>è°ƒç”¨è¯¥è§†å›¾æ—¶ä¼šæŠ¥é”™</li>
</ul>
</li>
<li><code>{{% extends &quot;base.html&quot; %}}</code> and <code>{{% include &quot;_post.html&quot; %}}</code> ä½¿ç”¨å­æ¨¡æ¿æ¥å®ç°ç½‘é¡µå…¬ç”¨çš„éƒ¨åˆ†ã€‚å¦‚ï¼šé¡µçœ‰ï¼Œé¡µè„šï¼Œåˆ—è¡¨é¡¹ç­‰ã€‚
<ul>
<li>æ¨¡æ¿å’Œ Python ä»£ç çš„å…³ç³»æœ‰äº›ç±»ä¼¼ä¸ JSP å’Œ Java ä»£ç çš„å…³ç³»ï¼Œä½†æ¨¡æ¿è¯­æ³•å¹¶ä¸æ˜¯å®Œæ•´çš„è„šæœ¬è¯­è¨€ï¼Œç›¸è¾ƒè€Œè¨€é™åˆ¶æ›´å¤šï¼Œå®‰å…¨æ€§æ›´å¥½ã€‚</li>
</ul>
</li>
</ul>
<h4 id="è¡¨å•">è¡¨å•</h4>
<blockquote>
<p>å‡ ä¹æ‰€æœ‰æˆåŠŸçš„æ¡†æ¶éƒ½æœ‰ä¸°å¯Œçš„æ’ä»¶ç”Ÿæ€ã€‚ä¸‹é¢å¼•å…¥æ–°åŠŸèƒ½æ—¶ï¼Œå¤§å¤šå€ŸåŠ©æ’ä»¶æ¥æ–¹ä¾¿çš„å®ç°ã€‚å¤§å¤šæ•°Flaskæ’ä»¶ä½¿ç”¨<code>flask_&lt;name&gt;</code> å‘½åçº¦å®šã€‚</p>
</blockquote>
<p>Flask-WTFæ’ä»¶æä¾›äº†å¯¹Webè¡¨å•çš„æŠ½è±¡ï¼Œåªéœ€å®šä¹‰è¡¨å•ç±»ä»¥åŠè®¾ç½®ç±»å±æ€§å³å¯ã€‚</p>
<p>æ¨¡æ¿è¯­æ³•ï¼š</p>
<ul>
<li><code>{{ form.&lt;name&gt;.label }}</code>æ¸²æŸ“æ ‡ç­¾</li>
<li><code>{{ form.&lt;name&gt;() }}</code>è·å–å±æ€§å€¼</li>
<li><code>form.hidden_tag()</code>æ¨¡æ¿å‚æ•°ç”Ÿæˆäº†ä¸€ä¸ªéšè—å­—æ®µï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªç”¨äºä¿æŠ¤è¡¨å•å…å—CSRFæ”»å‡»çš„token</li>
</ul>
<p>å°†è¡¨å•å¼•å…¥æ¨¡æ¿</p>
<pre><code class="language-python">form = LoginForm() # ç”Ÿæˆäº†ä¸€ä¸ªå®ä¾‹ä¼ å…¥æ¨¡æ¿
return render_template('login.html', title='Sign In', form=form)
</code></pre>
<h4 id="flash-é—ªç°æ¶ˆæ¯">flash é—ªç°æ¶ˆæ¯</h4>
<p>flash é€šè¿‡ session å‚¨å­˜ï¼Œç”¨äºæ˜¾ç¤ºåªå‡ºç°ä¸€æ¬¡çš„æç¤ºæ¶ˆæ¯ã€‚ç”¨æ³•ï¼š</p>
<ul>
<li>åœ¨è·¯ç”±ä¸­ä½¿ç”¨<code>flash()</code>ï¼Œè§¦å‘æ—¶æ¶ˆæ¯ä¾¿å†™å…¥ session ä¸­çš„ message åˆ—è¡¨</li>
<li>åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨<code>get_flashed_messages()</code>ï¼Œä» session ä¸­è¯»å–</li>
</ul>
<h2 id="0x02-æ•°æ®åº“-orm">0x02 æ•°æ®åº“ ORM</h2>
<p>å¾ˆä¹…å¾ˆä¹…ä»¥å‰ï¼Œwebç½‘ç«™å’Œæ•°æ®åº“äº¤äº’è¿˜éœ€è¦å†™å¾ˆå¤šå¾ˆç¡¬çš„ SQL è¯­å¥ï¼Œæ•ˆç‡ä½ä¸”å®¹æ˜“å‡ºç°æ³¨å…¥æ¼æ´(SQLi)ã€‚ç°ä»£webå¼€å‘éƒ½ä½¿ç”¨ ORM æ¡†æ¶ç®€åŒ–æ•°æ®åº“äº¤äº’ï¼Œä¸”åŸºæœ¬æœç»äº† SQLi æ¼æ´ã€‚</p>
<p>æœ¬é¡¹ç›®ä½¿ç”¨å¦‚ä¸‹æ’ä»¶æ‰“é€šæ•°æ®åº“ï¼š</p>
<ul>
<li>Flask-SQLAlchemy: Pythonç”Ÿæ€æœ€çŸ¥åçš„ORMæ¡†æ¶</li>
<li>Flask-Migrate: æœ¬æ•™ç¨‹ä½œè€…ç¼–å†™çš„æ•°æ®åº“è¿ç§»æ¡†æ¶</li>
</ul>
<blockquote>
<p>æ’ä»¶é¦–å…ˆè¦æ³¨å†Œã€‚ç»Ÿä¸€æµç¨‹: åˆå§‹åŒ–appå®ä¾‹ï¼Œä¼ å…¥æ’ä»¶ç±»ä½œä¸ºæ’ä»¶å®ä¾‹çš„å‚æ•°</p>
<pre><code class="language-python"># app/__init__.py
app = Flask(__name__) # flaskåŸºç±»
app.config.from_object(Config)
db = SQLAlchemy(app)
migrate = Migrate(app, db)
</code></pre>
</blockquote>
<h3 id="sqlalchemymodelå±‚">SQLalchemyï¼šmodelå±‚</h3>
<h4 id="æ¨¡å‹å®šä¹‰">æ¨¡å‹å®šä¹‰</h4>
<p>ä½¿ç”¨ç±»å’Œç±»å±æ€§ä»£è¡¨ table å’Œ colunm ï¼Œä¾¿å¯è½»æ¾ç¼–å†™æ•°æ®æ¨¡å‹ã€‚SQLalchemy çš„æ¦‚å¿µæŠ½è±¡å¦‚ä¸‹å›¾ï¼š<br>
<img src="https://lonelyuan.github.io/post-images/1631793936306.png" alt="" loading="lazy"></p>
<p>Flask-SQLAlchemy è‡ªåŠ¨è®¾ç½®ç±»åä¸ºå°å†™æ¥ä½œä¸ºå¯¹åº”è¡¨çš„åç§°ï¼Œä¹Ÿå¯ä»¥ç”¨<code>__tablename__</code>ç±»å±æ€§æ¥å®šä¹‰ã€‚</p>
<pre><code class="language-python">class Post(db.Model): # è¡¨
    id = db.Column(db.Integer, primary_key=True) # åˆ—
    ....
</code></pre>
<h4 id="curdåŸºæœ¬æ“ä½œ">CURDåŸºæœ¬æ“ä½œ</h4>
<p>ORM æ¡†æ¶é€šå¸¸é›†æˆäº†å¸¸ç”¨æ“ä½œï¼Œä½†ä¹Ÿæ”¯æŒæ›´åº•å±‚çš„æ•°æ®åº“æ¥å£ã€‚</p>
<blockquote>
<p>åœ¨ Springboot Jpa ä¸­ï¼Œæ ¹æ®æ–¹æ³•åçš„æ‹¼å†™æ¥å†™è‡ªå®šä¹‰æŸ¥è¯¢ï¼Œè€Œåœ¨ SQLalchemy ä¸­ï¼Œæä¾›çš„æ¥å£é€šè¿‡é“¾å¼è°ƒç”¨æ‹¼æ¥ã€‚</p>
</blockquote>
<p>åœ¨ SQLalchemy ä¸­ï¼ŒåŸºæœ¬æ“ä½œå¤§éƒ½æœ‰åŸºäºäº‹åŠ¡ (session) çš„å’ŒåŸºäºæŸ¥è¯¢ (query) çš„ä¸¤ç§æ–¹å¼ã€‚</p>
<ul>
<li>
<p>æŸ¥</p>
<pre><code class="language-python">session.query(User)
</code></pre>
<p>queryæ–¹æ³•åªæœ‰æ„é€ ä¸€ä¸ªæŸ¥è¯¢ï¼Œåªæœ‰åœ¨<code>Query.get()</code>ã€<code>Query.all()</code>ã€<code>Query.one()</code>ç­‰ç»“æŸç¬¦ä¹‹åæ‰ä¼šæ‰§è¡ŒæŸ¥è¯¢</p>
</li>
<li>
<p>å¢ï¼š</p>
<pre><code class="language-python">db.session.add(user)
db.session.commit()
</code></pre>
</li>
<li>
<p>åˆ </p>
<pre><code class="language-python">session.query(User).delete()
# or
session.delete(session.query(User).get(1))
session.commit()
</code></pre>
</li>
<li>
<p>æ”¹</p>
<pre><code class="language-python">query = (session
	.query(User)
	.filter_by(id=1)
	.update({&quot;username&quot;: User.username + &quot;a&quot;}, synchronize_session=False)
)
# or
user = (session.query(User).get(1))
user.password = &quot;zxcv&quot;
session.commit()
</code></pre>
</li>
</ul>
<h3 id="flask-migrate-æ•°æ®åº“è¿ç§»">Flask-Migrate: æ•°æ®åº“è¿ç§»</h3>
<p>é…ç½®æ•°æ®åº“çš„åˆå§‹æ•°æ®æ¡†æ¶ï¼Œä¸€èˆ¬å†™æˆSQLè„šæœ¬å½¢å¼ã€‚<br>
migrate æ¡†æ¶ç›´æ¥æ ¹æ® model å±‚ç”Ÿæˆè¿ç§»è„šæœ¬ï¼Œå¯ä»¥æ–¹ä¾¿çš„è·Ÿè¸ªæ•°æ®æ¨¡å‹çš„ä¿®æ”¹å’Œæ•°æ®åº“çš„åˆ‡æ¢ã€‚ï¼ˆè¿™ä¸ªæ¡†æ¶è¿˜æ˜¯æœ¬æ•™ç¨‹ä½œè€…è‡ªå·±å¼€å‘çš„ï¼Œå¼ºï¼‰</p>
<p>flask dbå­å‘½ä»¤</p>
<ul>
<li><code>flask db init</code>ï¼šåˆå§‹åŒ–ï¼Œç”Ÿæˆmigrationsç›®å½•</li>
<li><code>flask db migrate</code>ï¼šç”Ÿæˆè¿ç§»è„šæœ¬ï¼Œä¿®æ”¹modelåä½¿å…¶ç”Ÿæ•ˆ
<ul>
<li><code>flask db migrate -m &quot;posts table&quot;</code></li>
</ul>
</li>
<li><code>flask db upgrade</code>ï¼šåº”ç”¨æ•°æ®åº“ä¿®æ”¹ï¼ˆå¼€å‘é˜¶æ®µé»˜è®¤ä½¿ç”¨sqliteæ•°æ®åº“</li>
<li><code>flask db downgrade</code>ï¼šå›æ»šä¸Šæ¬¡çš„è¿ç§»</li>
</ul>
<h2 id="0x03-å¼€å‘èŒƒå¼ç”¨æˆ·ç³»ç»Ÿ">0x03 å¼€å‘èŒƒå¼ï¼šç”¨æˆ·ç³»ç»Ÿ</h2>
<blockquote>
<p>mixinï¼šæ··å…¥ï¼Œå¤šé‡ç»§æ‰¿çš„ä¸€ç§å½¢å¼</p>
</blockquote>
<p>è¡¨å•å’Œæ•°æ®åº“æ”¯æŒåˆ†åˆ«è§£å†³äº†å‰ç«¯å’Œåç«¯çš„åŸºæœ¬éœ€æ±‚ï¼Œä¸‹é¢å¯ä»¥ä¸Šçº¿ä¸€ä¸ªåŸºæœ¬åŠŸèƒ½äº†ï¼Œç”¨æˆ·ç™»å½•ã€‚<br>
æ‰€éœ€æ’ä»¶ï¼šFlask-Loginã€‚</p>
<h4 id="usermixinç±»">UserMixinç±»</h4>
<p>UserMixinç±»é›†æˆäº†loginæ’ä»¶è¦æ±‚çš„ç”¨æˆ·æ¨¡å‹å±æ€§ï¼Œå°†å…¶æ··å…¥åˆ° User æ¨¡å‹ä¸­ï¼Œå³å¯ç”¨<code>@login_required</code>å®ç°æƒé™æ§åˆ¶ã€‚</p>
<pre><code>@app.route('/result/', methods=['POST']) # NOTEï¼šæœ‰é¡ºåºå…³ç³»ï¼Œåä¹‹åˆ™ä¸ç”Ÿæ•ˆ
@login_required 
</code></pre>
<p>ç”¨æˆ·ç³»ç»Ÿï¼ŒåŒ…æ‹¬ç™»å½•ã€ç™»å‡ºã€æ³¨å†Œå‡ ä¸ªåŠŸèƒ½ã€‚ç¼–å†™è¿™äº›åŠŸèƒ½çš„æ­¥éª¤å…¶å®å¾ˆç±»ä¼¼ï¼š</p>
<ul>
<li>è®¾è®¡æ•°æ®åº“ï¼Œåœ¨model.pyä¸­</li>
<li>è®¾è®¡è¡¨å•å¯¹è±¡ï¼Œåœ¨form.pyä¸­</li>
<li>è®¾è®¡é¡µé¢ï¼Œåœ¨æ¨¡æ¿.htmlä¸­</li>
<li>è®¾è®¡è§†å›¾å‡½æ•°ï¼Œåœ¨routes.pyä¸­</li>
</ul>
<p>ä¹Ÿå¯¹åº”äº†mvcæ¡†æ¶çš„è®¾è®¡ç†å¿µï¼Œæ¯”å¦‚è®¾è®¡è¡¨å•å°±æœ‰äº›åƒ javaweb ä¸­çš„ DAO å±‚ã€‚ä½†ä¹Ÿæœ‰åŒºåˆ«ï¼Œ Flask æ¡†æ¶æ›´å¸Œæœ›ä¸šåŠ¡é€»è¾‘å†™åœ¨æ•°æ®åº“æ¨¡å‹ä¸­ï¼Œè€Œè§†å›¾å‡½æ•°å°½é‡ä¿æŒç®€æ´ï¼Œä»¥æ–¹ä¾¿å•å…ƒæµ‹è¯•ã€‚</p>
<h4 id="prg-æ¨¡å¼">PRG æ¨¡å¼</h4>
<p>å³ä¸º <code>Post/Redirect/Get</code>ï¼Œå…¶æ ¼å¼å¤§æ¦‚å¦‚ä¸‹ï¼š</p>
<pre><code class="language-python">@bp.route('/some_form', methods=['GET', 'POST'])
def some_form():
    # prepare forms 
    if form.validate_on_submit():
        # submit modification
        return redirect(url_for('main.some_form'))
    elif request.method == 'GET':
    	# GET data
    return render_template('some_form.html', form=form)
</code></pre>
<p>é»˜è®¤æƒ…å†µï¼Œæäº¤ POST è¯·æ±‚åï¼Œå¦‚æœç›´æ¥åˆ·æ–°æµè§ˆå™¨ï¼Œä¼šé‡æ–°åœ¨ POST ä¸€æ¬¡ã€‚ä½¿ç”¨PRGæ¨¡å¼å³å¯è§£å†³é‡å¤æäº¤è¡¨å•çš„é—®é¢˜ã€‚</p>
<h2 id="0x04-æ·±å…¥æ•°æ®åº“ç²‰ä¸æœºåˆ¶">0x04 æ·±å…¥æ•°æ®åº“ï¼šç²‰ä¸æœºåˆ¶</h2>
<h3 id="æ•°æ®åº“å…³ç³»">æ•°æ®åº“å…³ç³»</h3>
<p>è¦å…³æ³¨åˆ«äººï¼Œå°±è¦è®©æ•°æ®åº“è®°ä½æˆ‘å…³æ³¨çš„äººçš„åå­—ï¼Œå½“ç„¶ï¼Œåªè®°ä½åå­—è‚¯å®šä¸å¤Ÿï¼Œä¸‡ä¸€æ”¹åäº†å‘¢ã€‚å› æ­¤æ¯ä¸ªç”¨æˆ·éƒ½éœ€è¦æœ‰å”¯ä¸€æœ‰æ•ˆçš„æ ‡è¯†ï¼ˆå…¶å®æ›´é‡è¦çš„æ˜¯æ€§èƒ½å› ç´ ï¼‰ã€‚æ­£å› å¦‚æ­¤ï¼Œæ•°æ®åº“ä¸­æ¯ä¸ªè¡¨éƒ½è¦æœ‰ä¸€ä¸ªå”¯ä¸€çš„åˆ—ï¼Œç§°ä¸º<strong>ä¸»é”®</strong>(primary key)ã€‚å½“ä¸åŒè¡¨ä¹‹é—´å­˜åœ¨å…³ç³»ï¼Œä¸€ä¸ªè¡¨è¦é€šè¿‡ä¸»é”®å¯»æ‰¾å…¶ä»–è¡¨é¡¹ï¼Œå…¶ä»–è¡¨çš„ä¸»é”®å‚¨å­˜åœ¨æœ¬è¡¨ä¸­ï¼Œç§°ä¸º<strong>å¤–é”®</strong>(foreign key)ã€‚å¤–é”®å…³è”æ—¢å¯ä»¥è¡¨ç¤ºä¸€å¯¹ä¸€çš„å…³ç³»ï¼Œä¹Ÿå¯ä»¥ä¸€å¯¹å¤š(1-&gt;n)ã€‚</p>
<p>SQLalchemy å¯¹å…³ç³»çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<ul>
<li>å¤–é”®ï¼š<code>db.ForeignKey('user.id')</code></li>
<li>å…³ç³»ï¼š<code>db.relationship('Post', backref='author', lazy='dynamic')</code>
<ul>
<li>å‚æ•°1ï¼šæ‰€å…³è”çš„è¡¨(n in 1-&gt;n)ï¼Œè¿™é‡Œæ˜¯æ¨¡å‹çš„å˜é‡å</li>
<li>å‚æ•°2ï¼šç”± &quot;n&quot; å›è°ƒ &quot;1&quot; çš„è™šæ‹Ÿå­—æ®µï¼Œç”¨æ³•ï¼š<code>post.author</code></li>
</ul>
</li>
</ul>
<h3 id="ç²‰ä¸æœºåˆ¶">ç²‰ä¸æœºåˆ¶</h3>
<p>ç„¶è€Œï¼Œç²‰ä¸æœºåˆ¶åŒ…æ‹¬å…³æ³¨å’Œè¢«å…³æ³¨ã€‚è¿™æ˜¯ä¸€ç§å¤šå¯¹å¤šçš„å…³ç³»ï¼Œäºæ˜¯éœ€è¦ç”¨å«æœ‰ä¸¤ä¸ªå¤–é”®çš„<strong>å…³è”è¡¨</strong>è¡¨ç¤ºã€‚åˆå› ä¸ºå…³æ³¨è€…å’Œè¢«å…³æ³¨è€…åœ¨ä¸€ä¸ªè¡¨é‡Œï¼ˆUserï¼‰ï¼Œè¿™ç§å…³ç³»åˆç§°ä¸º<strong>è‡ªå¼•ç”¨</strong>ã€‚</p>
<h4 id="æ¨¡å‹">æ¨¡å‹</h4>
<ul>
<li>
<p>å…³è”è¡¨åªæœ‰å¼•ç”¨ç±»å‹ï¼Œæ•…ä¸éœ€è¦æ´¾ç”Ÿæ¨¡å‹ç±»</p>
<pre><code class="language-python">followers = db.Table(
    'followers',
    db.Column('follower_id', db.Integer, db.ForeignKey('user.id')),
    db.Column('followed_id', db.Integer, db.ForeignKey('user.id'))
)
</code></pre>
</li>
<li>
<p>ä¸ºUseræ·»åŠ å…³ç³»</p>
<pre><code class="language-python">followed = db.relationship('User', # å³ä¾§å®ä½“
    secondary=followers, # æŒ‡å®šå…³è”è¡¨
    primaryjoin=(followers.c.follower_id == id), # æŒ‡å®šå·¦å…³ç³»
    secondaryjoin=(followers.c.followed_id == id), # æŒ‡å®šå³å…³ç³»
    backref=db.backref('followers', lazy='dynamic'), lazy='dynamic') # æŒ‡å®šå›è°ƒ
</code></pre>
</li>
</ul>
<h4 id="å¤æ‚æŸ¥è¯¢">å¤æ‚æŸ¥è¯¢</h4>
<ul>
<li>
<p>æŸ¥è¯¢ç²‰ä¸åˆ—è¡¨</p>
<ul>
<li>
<p>SQL è¯­å¥ï¼š<code>SELECT * FROM user, followers WHERE followers.follower_id = 3 AND followers.followed_id = user.id</code></p>
</li>
<li>
<p>SQLalchemy æ¥å£ï¼š<code>user.followers.all()</code></p>
</li>
<li>
<p>å®é™…æ‰§è¡Œçš„ SQL è¯­å¥ï¼šï¼ˆæ‰“å° query å¯¹è±¡å¾—åˆ°ï¼‰</p>
<pre><code>SELECT ,,,  FROM user, followers 
WHERE followers.followed_id = ? AND followers.follower_id = user.id
</code></pre>
</li>
<li>
<p>NOTEï¼šå¦‚æœæ–¹æ³•é›†æˆåœ¨modelé‡Œï¼Œæ–¹æ³•åä¸è¦å’Œå­—æ®µåç›¸åŒï¼Œè‡ªå·±å®šä¹‰çš„æ–¹æ³•ä¼šè¦†ç›–è¯¥å­—æ®µã€‚</p>
</li>
</ul>
</li>
<li>
<p>æŸ¥çœ‹å·²å…³æ³¨ç”¨æˆ·çš„åŠ¨æ€</p>
<ul>
<li>
<p>SQL è¯­å¥ï¼š<code>SELECT * FROM post JOIN followers on followers.followed_id = post.user_id where followers.follower_id = 2</code></p>
</li>
<li>
<p>SQLalchemy æ¥å£ï¼š</p>
</li>
</ul>
<pre><code class="language-sql">Post.query.join(
  followers, (followers.c.followed_id == Post.user_id)).filter(
    followers.c.follower_id == self.id).order_by(
       Post.timestamp.desc())
</code></pre>
<ul>
<li>
<p>å®é™…æ‰§è¡Œçš„SQLè¯­å¥ï¼š</p>
<pre><code class="language-sql">SELECT ,,, FROM 
(SELECT ,,,
   FROM post JOIN followers ON followers.followed_id = post.user_id 
   WHERE followers.follower_id = ? 
   UNION SELECT * 
   FROM post 
   WHERE post.user_id = ?
) 
AS anon_1 ORDER BY anon_1.post_timestamp DESC
</code></pre>
</li>
</ul>
</li>
</ul>
<p>ç”±äºpythonçš„å¼±ç±»å‹ç‰¹å¾ï¼Œæœ‰æ—¶å€™å¾ˆéš¾æ˜ç™½å‡½æ•°ä¹‹é—´ä¼ é€’çš„æ˜¯ä»€ä¹ˆå¯¹è±¡ã€‚æˆ‘ä»¬ä»ä¸Šå¾€ä¸‹æ¢³ç†ä¸€éï¼š</p>
<ul>
<li>è¯·æ±‚åˆ°è¾¾è·¯ç”±å‡½æ•°ï¼Œå¼€å§‹æ‰§è¡ŒæŸ¥è¯¢<code>Post.query.....</code>ï¼Œæ­¤æ—¶åªæ˜¯åœ¨æ„é€ æŸ¥è¯¢ï¼Œå¹¶æœªå–å¾—æ•°æ®ï¼Œæ­¤æ—¶çš„å¯¹è±¡ç±»å‹ï¼š<code>&lt;class 'sqlalchemy.orm.query.Query'&gt;</code></li>
<li>ç›´åˆ°<code>get()</code>,<code>all()</code>,<code>paginate().items</code>ç»“æŸç¬¦ç­‰å‡ºç°ï¼ŒæŸ¥è¯¢æ‰è¢«æ‰§è¡Œï¼Œè¿”å›æ•°æ®ç±»å‹å®ä¾‹ï¼Œå¦‚Userã€‚</li>
<li>æ•°æ®ç±»å®ä¾‹ä¼ å…¥æ¨¡æ¿ï¼Œå¹¶ç”±<code>__str__</code>ç­‰æ–¹æ³•å‚ä¸æ¸²æŸ“ã€‚</li>
</ul>
<h2 id="0x05-ç½‘ç«™ç¾åŒ–">0x05 ç½‘ç«™ç¾åŒ–</h2>
<p>æœ¬æ•™ç¨‹æä¾›çš„flask-bootstrapæ’ä»¶ï¼Œè¾ƒä¸ºç®€é™‹ï¼Œä¸”è¯¥æ’ä»¶å¹´ä¹…å¤±ä¿®ï¼Œé‚æ›¿æ¢ä¹‹ã€‚åœ¨æ­¤ä¹‹å‰ï¼Œå…ˆææ˜ç™½ç›®å‰é¡¹ç›®å‰ç«¯çš„æ¶æ„</p>
<pre><code>/templates
   auth/
   errors/
   base.html
   _posts.html
   index.html
   ... 
</code></pre>
<p>æ‰€æœ‰æ¨¡æ¿éƒ½æœ‰ä¸€ä¸ªçˆ¶æ¨¡ç‰ˆï¼š<code>base.html</code>ï¼Œå…¶ç»“æ„å¦‚ä¸‹ï¼š</p>
<pre><code class="language-html">{% extends 'bootstrap/base.html' %}
{% block title %}Hallo Wolrd{% endblock %}
{% block head %} ... {% endblock %}
{% block scripts %} ... {% endblock %}
{% block navbar %} ... {% endblock %}
{% block content %}
    ...
    {% block app_content %}{% endblock %}
{% endblock %}
</code></pre>
<p><code>app_content</code>ç•™ç©ºï¼Œå³å…¶ä½™æ¨¡æ¿å‡åœ¨<code>app_content</code>å†…å¡«å……ã€‚</p>
<p>è¿›ä¸€æ­¥è¿½æº¯<code>bootstrap/base.html</code>çš„æºç ï¼Œå‘ç°å…¶å®ƒ block è¯¸å¦‚<code>navbar</code>ä¹Ÿéƒ½ç•™ç©ºæˆ–ä»…ä»…é…ç½®äº† Bootstrap çš„ cdnã€‚ ç”±æ­¤ï¼Œåªéœ€å°†<code>base.html</code>è¿ç§»å³å¯ã€‚</p>
<p>åœ¨ç½‘ä¸Šå¯»æ‰¾æ–°çš„UIæ¨¡æ¿ï¼Œä¸è¦åœ¨ä¸­æ–‡äº’è”ç½‘æœç´¢ï¼Œbasically garbageã€‚æ‰¾åˆ°ä¸€ä¸ª <a href="https://demos.creative-tim.com/material-kit/index.html">Meterial æ¨¡æ¿</a> è¿˜ç®—é¡ºçœ¼ï¼Œé‚ç”¨ä¹‹ã€‚</p>
<p>ä¸ç†Ÿæ‚‰ Bootstrap å¸ƒå±€çš„å¯ä»¥ä½¿ç”¨å¯è§†åŒ–å·¥å…·æ¥è®¾è®¡å‰ç«¯ï¼Œå¦‚ï¼šhttp://www.ibootstrap.cn/</p>
<p>å¯¹ç…§æ¨¡æ¿ï¼Œå°†<code>base.html</code>æç©ºï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p>
<figure data-type="image" tabindex="1"><img src="https://lonelyuan.github.io/post-images/1631795716824.png" alt="" loading="lazy"></figure>
<p>é‡åˆ°çš„bugæœ‰ï¼š</p>
<ul>
<li>ä¸‹æ‹‰èœå•å¤±æ•ˆï¼šæŸ¥è¯¢å¾—çŸ¥æœ‰å¯èƒ½æ˜¯bootstrapç‰ˆæœ¬å†²çª
<ul>
<li>//ç»“æœå¹¶ä¸æ˜¯ï¼Œåªæ˜¯å¿˜è®°å¼•å…¥jsæ–‡ä»¶è€Œå·²ï¼Œæˆ‘æ˜¯å‚»é€¼ã€‚</li>
</ul>
</li>
<li>æ–‡ä»¶ä¸Šä¼ æŒ‰é’®æ¶ˆå¤±ï¼šæœ¬æ•™ç¨‹ä¸­ï¼Œè¡¨å•æ¸²æŸ“é‡‡ç”¨<code>wtf.quick_form()</code>ï¼Œè¿™ç©æ„è¿˜æ˜¯æ¥è‡ª<code>bootstrap/wtf.html</code></li>
</ul>
<p>æœ€åå†³å®šæ•´ä¸ªğŸäº† Flask-Bootstrap æ’ä»¶ã€‚</p>
<h4 id="å¯Œæ–‡æœ¬ç¼–è¾‘å™¨">å¯Œæ–‡æœ¬ç¼–è¾‘å™¨</h4>
<p>åœ¨ã€ŠFlask Webå¼€å‘ï¼šåŸºäºPythonçš„Webåº”ç”¨å¼€å‘å®æˆ˜ã€‹ä¸­æåˆ°äº†markdownç¼–è¾‘å™¨çš„å®ç°ã€‚</p>
<p>éœ€è¦çš„åŒ…ï¼š</p>
<ul>
<li>PageDown: JS ç‰ˆ Markdown æ¸²æŸ“å™¨ï¼Œç”¨äºå®¢æˆ·ç«¯é¢„è§ˆã€‚</li>
<li>Flask-PageDown: flask é›†æˆæ’ä»¶ã€‚è¯¥æ’ä»¶éœ€è¦æ³¨å†Œ</li>
<li>Markdown: Python ç‰ˆ Markdown æ¸²æŸ“å™¨ï¼Œç”¨äºæœåŠ¡ç«¯æ¸²æŸ“ã€‚</li>
<li>Bleach: HTML æ¸…ç†å™¨ï¼Œä¿è¯å®‰å…¨æ€§</li>
</ul>
<p>ä¸ºäº†å…¼é¡¾å®‰å…¨å’Œæ•ˆç‡ï¼Œåšæ³•æ˜¯åŒæ—¶ä¿å­˜ markdown æºæ–‡æœ¬å’Œ HTML æ–‡ä»¶ã€‚æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ul>
<li>è¡¨å•æ”¹ä¸º <code>PageDownField</code></li>
<li>æ¨¡æ¿å¼•å…¥ PageDown å®ï¼Œä»¥å®ç°å³æ—¶é¢„è§ˆ</li>
<li>ä¸º Post æ¨¡å‹å¢åŠ å­—æ®µï¼Œå¹¶æ·»åŠ  markdown æ¸²æŸ“æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸ºç±»æ–¹æ³•ï¼Œéœ€è¦<code>@staticmethod</code>ä¿®é¥°</li>
<li>åœ¨æ¨¡å‹å¤–éƒ¨ç›‘å¬æ•°æ®åº“äº‹ä»¶ï¼Œä»…å½“ markdown æ–‡æœ¬å‡ºç°å˜åŠ¨æ—¶è°ƒç”¨æ¸²æŸ“æ–¹æ³•ã€‚</li>
<li>ä¿®æ”¹æ¨¡æ¿ä»¥æ˜¾ç¤ºæœåŠ¡ç«¯è¿”å›çš„ html æ–‡æœ¬</li>
</ul>
<p>ç„¶è€Œé¢„è§ˆå™¨è¿‡äºç®€é™‹ï¼Œä¹Ÿå¾ˆéš¾ä¿®æ”¹ã€‚åœ¨githubä»“åº“ä¸Šå‘ç°è¯¥æ’ä»¶ä¹Ÿæ˜¯æœ¬æ•™ç¨‹ä½œè€…å†™çš„ï¼Œå·²ç»å¾ˆä¹…æ²¡æœ‰ç»´æŠ¤ã€‚é¡¿æ—¶å¯¹æœ¬ä¹¦ä½œè€…æœ‰äº›ä¸æ»¡ã€‚</p>
<h2 id="0x06-æ¨¡å—åŒ–åº”ç”¨åŠŸèƒ½è§£è€¦">0x06 æ¨¡å—åŒ–åº”ç”¨ï¼šåŠŸèƒ½è§£è€¦</h2>
<p>ä¿æŒ app ä½œä¸ºå…¨å±€å˜é‡çš„æ¨¡å¼ï¼Œå¯èƒ½ä¼šç»™åç»­å¼•å…¥æ–°åŠŸèƒ½å’Œå•å…ƒæµ‹è¯•å¸¦æ¥éº»çƒ¦ã€‚<br>
è¦é€‚åº”å¤§å‹é¡¹ç›®éœ€æ±‚ï¼Œéœ€è¦æŠŠç½‘ç«™åŠŸèƒ½æ‹†åˆ†æˆç‹¬ç«‹çš„æ¨¡å—ã€‚</p>
<h3 id="blueprintåŒ–">BlueprintåŒ–</h3>
<p>è¦å®ç°è§£è€¦ï¼Œä¸€ç§åŠŸèƒ½çš„ç›¸å…³ä»£ç å¯ä»¥å€ŸåŠ©Blueprintå½’ç±»åˆ°ä¸€ä¸ªåŒ…é‡Œã€‚å…¶æ–‡ä»¶ç»“æ„å¤§è‡´å¦‚ä¸‹ï¼š</p>
<pre><code class="language-angular2html">app/ 
    some_fuction/                       &lt;-- blueprint package
        __init__.py                     &lt;-- blueprint creation
        ... other code ...
    templates/
        some_fuction/                   &lt;--  templates
    __init__.py                         &lt;-- blueprint registration
</code></pre>
<p>åˆ›å»ºblueprintä¸åˆ›å»ºåº”ç”¨éå¸¸ç›¸ä¼¼ã€‚</p>
<pre><code class="language-python">from flask import Blueprint
bp = Blueprint('func', __name__)
from app.func import Func
</code></pre>
<p>è€Œæ¶ˆç­äº†<code>app</code>ï¼Œè“å›¾å†…éƒ¨çš„å¼•ç”¨ç»Ÿä¸€å˜æˆäº†è“å›¾åã€‚è€Œå¤–éƒ¨è¯¸å¦‚<code>url_for</code>çš„å‚æ•°åˆ™éœ€è¦åŠ ä¸Š<code>åŒ…å.</code>åšå‰ç¼€ã€‚</p>
<h3 id="åº”ç”¨å·¥å‚æ¨¡å¼">åº”ç”¨å·¥å‚æ¨¡å¼</h3>
<p>å·¥å‚å‡½æ•°æ˜¯ä¸€ä¸ªå¤–éƒ¨å‡½æ•°ï¼Œåœ¨è¿™ä¸ªå‡½æ•°å†…éƒ¨æ‰§è¡Œæ’ä»¶æ³¨å†Œå’Œé…ç½®å·¥ä½œï¼Œå¹¶é€šè¿‡ä»–è¿”å›åº”ç”¨å®ä¾‹ã€‚</p>
<pre><code class="language-python"># app/__init__.py
db = SQLAlchemy()
# ...
def create_app(config_class=Config):
    app = Flask(__name__)
    app.config.from_object(config_class)
    db.init_app(app)
    # ...
</code></pre>
<p>è¿”å›åï¼Œflaskæä¾›çš„ä¸Šä¸‹æ–‡å¯¹è±¡<code>current_app</code>å°†æŒ‡å‘åº”ç”¨å®ä¾‹ã€‚è¯¦è§å®˜æ–¹æ–‡æ¡£ï¼š<a href="http://docs.jinkan.org/docs/flask/appcontext.html">åº”ç”¨ä¸Šä¸‹æ–‡</a></p>
<h4 id="å¤šçº¿ç¨‹">å¤šçº¿ç¨‹</h4>
<p><code>current_app</code>æ˜¯çº¿ç¨‹ç»‘å®šçš„ï¼Œè‹¥è¦åœ¨è¯¸å¦‚é‚®ä»¶æœåŠ¡çš„ä½äºå…¶ä»–çº¿ç¨‹çš„åŠŸèƒ½è°ƒç”¨ä»–ï¼Œåˆ™ä¼šå‘ç°æ²¡æœ‰èµ‹å€¼ã€‚<br>
éœ€è¦ä½¿ç”¨<code>current_app._get_current_object()</code>è¡¨è¾¾å¼ã€‚</p>
<h4 id="pythonæ¦‚å¿µè¾¨æåŒ…åº“æ’ä»¶">Pythonæ¦‚å¿µè¾¨æï¼šåŒ…ï¼Œåº“ï¼Œæ’ä»¶</h4>
<blockquote>
<p>åŒ… (package) æ˜¯æŒ‡ä¸€ç§ä»£ç ç»“æ„ï¼Œåªè¦æœ‰æ–‡ä»¶å¤¹å’Œ <code>__init__.py</code> éƒ½æ˜¯åŒ…ã€‚<br>
åº“ (library) å’Œæ’ä»¶ (plugin) éƒ½æ˜¯ä»å¤–éƒ¨å¼•å…¥çš„åŒ…ï¼ŒåŒºåˆ«åœ¨äºï¼Œæ’ä»¶è¦é›†æˆè¿›åº”ç”¨ï¼Œæ‰€ä»¥éœ€è¦æ³¨å†Œç­‰æ­¥éª¤ï¼›è€Œåº“æ›´ç‹¬ç«‹ï¼Œå¯ä»¥éšæ—¶éšåœ°è°ƒç”¨</p>
</blockquote>
<h2 id="0x07-å¼€å‘å¸®æ‰‹">0x07 å¼€å‘å¸®æ‰‹</h2>
<p>æœ¬èŠ‚è®²è§£ä¸€äº›æ‚é¡¹ã€‚</p>
<h4 id="è°ƒè¯•">è°ƒè¯•</h4>
<ul>
<li><code>flask shell</code>å‘½ä»¤ï¼šä¸ºé¿å…æ¯æ¬¡è°ƒè¯•éƒ½è¦é‡æ–°import appï¼Œä½¿ç”¨ä¸Šä¸‹æ–‡è°ƒç”¨è§£é‡Šå™¨ï¼Œç”¨<code>@app.shell_context_processor</code>è£…é¥°ä¸Šä¸‹æ–‡å‡½æ•°</li>
</ul>
<h4 id="å•å…ƒæµ‹è¯•">å•å…ƒæµ‹è¯•</h4>
<p>unittest åº“ï¼Œè¯¦è§<a href="">ä¸‹ä¸€ç¯‡</a>ã€‚</p>
<h4 id="è®°å½•æ—¥å¿—åˆ°æ–‡ä»¶">è®°å½•æ—¥å¿—åˆ°æ–‡ä»¶</h4>
<p>logger åº“</p>
<pre><code class="language-python">    if not app.debug:
        if not os.path.exists('logs'):
            os.mkdir('logs')
        file_handler = RotatingFileHandler('logs/microblog.log', maxBytes=10240,
                                           backupCount=10)
        file_handler.setFormatter(logging.Formatter(
            '%(asctime)s %(levelname)s: %(message)s [in %(pathname)s:%(lineno)d]'))
        file_handler.setLevel(logging.INFO)
        app.logger.addHandler(file_handler)

        app.logger.setLevel(logging.INFO)
        app.logger.info('Microblog startup')
</code></pre>
<h4 id="requirementtxt">requirement.txt</h4>
<p>è£…çš„åº“å¤ªå¤šæ€ä¹ˆåŠï¼Ÿåªéœ€è¦ä¸¤æ¡å‘½ä»¤ï¼š</p>
<pre><code class="language-shell">pip freeze &gt; requirements.txt
pip install -r requirements.txt
</code></pre>
<h2 id="0x08-ç½‘ç«™ä¸Šçº¿">0x08 ç½‘ç«™ä¸Šçº¿</h2>
<p>æœ€åç®€å•åˆ—å‡ºå‡ ç§ç½‘ç«™éƒ¨ç½²çš„æ–¹æ³•ï¼Œè¯¦æƒ…å‚è€ƒæœ¬æ•™ç¨‹æˆ–è‡ªè¡Œæœç´¢ã€‚</p>
<h4 id="nativeæ¨¡å¼">nativeæ¨¡å¼</h4>
<ul>
<li>ä¹°ä¸»æœº
<ul>
<li>è¿ä¸»æœºï¼šssh</li>
</ul>
</li>
<li>ä¹°åŸŸå
<ul>
<li>é…åŸŸå</li>
</ul>
</li>
<li>é…ç¯å¢ƒ
<ul>
<li>æ•°æ®åº“</li>
<li>æœåŠ¡å™¨</li>
<li>å…¶ä»–ä¾èµ–</li>
</ul>
</li>
<li>æŒç»­è¿ç»´</li>
</ul>
<h4 id="å®¹å™¨åŒ–æŠ€æœ¯docker">å®¹å™¨åŒ–æŠ€æœ¯ï¼šdocker</h4>
<ul>
<li>å†™dockerfile</li>
<li>docker-compose up --build -d</li>
</ul>
<h4 id="äº‘æŠ€æœ¯paas">äº‘æŠ€æœ¯ï¼šPaaS</h4>
<ul>
<li>æ³¨å†Œäº‘å¹³å°è´¦æˆ·</li>
<li>å†™Procfile</li>
<li>git push</li>
</ul>

                </div>
            </article>
        </div>

        
            <div class="next-post">
                <div class="next gt-c-content-color-first">ä¸‹ä¸€ç¯‡</div>
                <a href="https://lonelyuan.github.io/post/awd-da-pian/" class="post-title gt-a-link">
                    CISCN2021åä¸œç™¾èµ›åŒºåˆ†åŒºé€‰æ‹”èµ›AWDå¤ç›˜
                </a>
            </div>
        

        

        
            
                <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js"></script>
<script>
    // md5.min.js
    !function(n){
        "use strict";
        function d(n,t){var r=(65535&n)+(65535&t);return(n>>16)+(t>>16)+(r>>16)<<16|65535&r}
        function f(n,t,r,e,o,u){return d((c=d(d(t,n),d(e,u)))<<(f=o)|c>>>32-f,r);var c,f}
        function l(n,t,r,e,o,u,c){return f(t&r|~t&e,n,t,o,u,c)}
        function v(n,t,r,e,o,u,c){return f(t&e|r&~e,n,t,o,u,c)}
        function g(n,t,r,e,o,u,c){return f(t^r^e,n,t,o,u,c)}
        function m(n,t,r,e,o,u,c){return f(r^(t|~e),n,t,o,u,c)}
        function i(n,t){var r,e,o,u,c;n[t>>5]|=128<<t%32,n[14+(t+64>>>9<<4)]=t;var f=1732584193,i=-271733879,a=-1732584194,h=271733878;for(r=0;r<n.length;r+=16)f=l(e=f,o=i,u=a,c=h,n[r],7,-680876936),h=l(h,f,i,a,n[r+1],12,-389564586),a=l(a,h,f,i,n[r+2],17,606105819),i=l(i,a,h,f,n[r+3],22,-1044525330),f=l(f,i,a,h,n[r+4],7,-176418897),h=l(h,f,i,a,n[r+5],12,1200080426),a=l(a,h,f,i,n[r+6],17,-1473231341),i=l(i,a,h,f,n[r+7],22,-45705983),f=l(f,i,a,h,n[r+8],7,1770035416),h=l(h,f,i,a,n[r+9],12,-1958414417),a=l(a,h,f,i,n[r+10],17,-42063),i=l(i,a,h,f,n[r+11],22,-1990404162),f=l(f,i,a,h,n[r+12],7,1804603682),h=l(h,f,i,a,n[r+13],12,-40341101),a=l(a,h,f,i,n[r+14],17,-1502002290),f=v(f,i=l(i,a,h,f,n[r+15],22,1236535329),a,h,n[r+1],5,-165796510),h=v(h,f,i,a,n[r+6],9,-1069501632),a=v(a,h,f,i,n[r+11],14,643717713),i=v(i,a,h,f,n[r],20,-373897302),f=v(f,i,a,h,n[r+5],5,-701558691),h=v(h,f,i,a,n[r+10],9,38016083),a=v(a,h,f,i,n[r+15],14,-660478335),i=v(i,a,h,f,n[r+4],20,-405537848),f=v(f,i,a,h,n[r+9],5,568446438),h=v(h,f,i,a,n[r+14],9,-1019803690),a=v(a,h,f,i,n[r+3],14,-187363961),i=v(i,a,h,f,n[r+8],20,1163531501),f=v(f,i,a,h,n[r+13],5,-1444681467),h=v(h,f,i,a,n[r+2],9,-51403784),a=v(a,h,f,i,n[r+7],14,1735328473),f=g(f,i=v(i,a,h,f,n[r+12],20,-1926607734),a,h,n[r+5],4,-378558),h=g(h,f,i,a,n[r+8],11,-2022574463),a=g(a,h,f,i,n[r+11],16,1839030562),i=g(i,a,h,f,n[r+14],23,-35309556),f=g(f,i,a,h,n[r+1],4,-1530992060),h=g(h,f,i,a,n[r+4],11,1272893353),a=g(a,h,f,i,n[r+7],16,-155497632),i=g(i,a,h,f,n[r+10],23,-1094730640),f=g(f,i,a,h,n[r+13],4,681279174),h=g(h,f,i,a,n[r],11,-358537222),a=g(a,h,f,i,n[r+3],16,-722521979),i=g(i,a,h,f,n[r+6],23,76029189),f=g(f,i,a,h,n[r+9],4,-640364487),h=g(h,f,i,a,n[r+12],11,-421815835),a=g(a,h,f,i,n[r+15],16,530742520),f=m(f,i=g(i,a,h,f,n[r+2],23,-995338651),a,h,n[r],6,-198630844),h=m(h,f,i,a,n[r+7],10,1126891415),a=m(a,h,f,i,n[r+14],15,-1416354905),i=m(i,a,h,f,n[r+5],21,-57434055),f=m(f,i,a,h,n[r+12],6,1700485571),h=m(h,f,i,a,n[r+3],10,-1894986606),a=m(a,h,f,i,n[r+10],15,-1051523),i=m(i,a,h,f,n[r+1],21,-2054922799),f=m(f,i,a,h,n[r+8],6,1873313359),h=m(h,f,i,a,n[r+15],10,-30611744),a=m(a,h,f,i,n[r+6],15,-1560198380),i=m(i,a,h,f,n[r+13],21,1309151649),f=m(f,i,a,h,n[r+4],6,-145523070),h=m(h,f,i,a,n[r+11],10,-1120210379),a=m(a,h,f,i,n[r+2],15,718787259),i=m(i,a,h,f,n[r+9],21,-343485551),f=d(f,e),i=d(i,o),a=d(a,u),h=d(h,c);return[f,i,a,h]}
        function a(n){var t,r="",e=32*n.length;for(t=0;t<e;t+=8)r+=String.fromCharCode(n[t>>5]>>>t%32&255);return r}
        function h(n){var t,r=[];for(r[(n.length>>2)-1]=void 0,t=0;t<r.length;t+=1)r[t]=0;var e=8*n.length;for(t=0;t<e;t+=8)r[t>>5]|=(255&n.charCodeAt(t/8))<<t%32;return r}
        function e(n){var t,r,e="0123456789abcdef",o="";for(r=0;r<n.length;r+=1)t=n.charCodeAt(r),o+=e.charAt(t>>>4&15)+e.charAt(15&t);return o}
        function r(n){return unescape(encodeURIComponent(n))}
        function o(n){return a(i(h(t=r(n)),8*t.length));var t}
        function u(n,t){return function(n,t){var r,e,o=h(n),u=[],c=[];for(u[15]=c[15]=void 0,16<o.length&&(o=i(o,8*n.length)),r=0;r<16;r+=1)u[r]=909522486^o[r],c[r]=1549556828^o[r];return e=i(u.concat(h(t)),512+8*t.length),a(i(c.concat(e),640))}(r(n),r(t))}
        function t(n,t,r){return t?r?u(t,n):e(u(t,n)):r?o(n):e(o(n))}
        "function"==typeof define&&define.amd?define(function(){return t}):"object"==typeof module&&module.exports?module.exports=t:n.md5=t;
    }(this);
</script>


<div id="gitalk-container"></div>

<script>

  var gitalk = new Gitalk({
    clientID: '51da5c60f4f56c7257ec',
    clientSecret: 'c6208164907a36b5b54077802ac3319a9dc833f9',
    repo: 'gitalk_comments',
    owner: 'lonelyuan',
    admin: ['lonelyuan'],
    id: md5(location.pathname),      // Ensure uniqueness and length less than 50
    distractionFreeMode: false       // Facebook-like distraction free mode
  })

  gitalk.render('gitalk-container')

</script>

            

            
        

        

        <div class="site-footer gt-c-content-color-first">
    <div class="slogan gt-c-content-color-first"> >> ä¸è¦ææ…Œ | Don't Panic </div>
    <div class="social-container">
        
            
                <a href="https://github.com/lonelyuan" target="_blank">
                    <i class="fab fa-github gt-c-content-color-first"></i>
                </a>
            
        
            
                <a href="https://twitter.com/FTrumpyeah" target="_blank">
                    <i class="fab fa-twitter gt-c-content-color-first"></i>
                </a>
            
        
            
        
            
        
            
        
            
        
    </div>
    <div class="footer-info">
        
    </div>
    <div>
        Theme by <a href="https://imhanjie.com/" target="_blank">imhanjie</a>, Powered by <a
                href="https://github.com/getgridea/gridea" target="_blank">Gridea | <a href="https://lonelyuan.github.io/atom.xml" target="_blank">RSS</a></a>
    </div>
</div>

<script>
  hljs.initHighlightingOnLoad()
</script>

    </div>
</div>
</body>
</html>
