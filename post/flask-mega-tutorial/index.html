<html>
<head>
    <meta charset="utf-8" />
<meta name="description" content="" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>年轻人的第二个网站 - The Flask Mega Tutorial | lonelyuan&#39;s Blog</title>

<link rel="shortcut icon" href="https://lonelyuan.github.io/favicon.ico?v=1636619068159">

<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://lonelyuan.github.io/styles/main.css">
<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css"> -->

<style>
    hr {
        margin-top: 1rem;
        margin-bottom: 1rem;
        border: 0;
        border-top: 1px solid rgba(0, 0, 0, 0.1);
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets/highlight.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dockerfile.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dart.min.js"></script>

<!-- <script src="https://cdn.jsdelivr.net/npm/moment@2.27.0/moment.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.min.js"></script> -->
<!-- DEMO JS -->
<!--<script src="media/scripts/index.js"></script>-->


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.css">
</head>
<body>
<div class="main gt-bg-theme-color-first">
    <style>
    /* 导航栏样式 */
    .navbar {
        position: relative;
        display: -ms-flexbox;
        display: flex;
        -ms-flex-wrap: wrap;
        flex-wrap: wrap;
        -ms-flex-align: center;
        align-items: center;
        -ms-flex-pack: justify;
        justify-content: space-between;
        padding: 0.5rem 1rem;
    }

    .navbar-brand {
        display: inline-block;
        padding-top: 0.3125rem;
        padding-bottom: 0.3125rem;
        margin-right: 1rem;
        font-size: 1.25rem;
        line-height: inherit;
        white-space: nowrap;
    }

    .navbar-brand:hover,
    .navbar-brand:focus {
        text-decoration: none;
    }

    .navbar-nav {
        display: -ms-flexbox;
        display: flex;
        -ms-flex-direction: column;
        flex-direction: column;
        padding-left: 0;
        margin-bottom: 0;
        list-style: none;
    }

    .navbar-collapse {
        -ms-flex-preferred-size: 100%;
        flex-basis: 100%;
        -ms-flex-positive: 1;
        flex-grow: 1;
        -ms-flex-align: center;
        align-items: center;
    }

    .navbar-toggler {
        padding: 0.25rem 0.75rem;
        font-size: 1.25rem;
        line-height: 1;
        background-color: transparent;
        border: 1px solid transparent;
        border-radius: 0.25rem;
    }

    .navbar-toggler:hover,
    .navbar-toggler:focus {
        text-decoration: none;
    }

    @media (min-width: 992px) {
        .navbar-expand-lg {
            -ms-flex-flow: row nowrap;
            flex-flow: row nowrap;
            -ms-flex-pack: start;
            justify-content: flex-start;
        }

        .navbar-expand-lg .navbar-nav {
            -ms-flex-direction: row;
            flex-direction: row;
        }

        .navbar-expand-lg .navbar-collapse {
            display: -ms-flexbox !important;
            display: flex !important;
            -ms-flex-preferred-size: auto;
            flex-basis: auto;
        }

        .navbar-expand-lg .navbar-toggler {
            display: none;
        }
    }

    @media (max-width: 991px) {
        #navbarSupportedContent {
            display: none;
        }
    }
</style>
<nav class="navbar navbar-expand-lg">
    <div class="navbar-brand">
        <img class="user-avatar" src="/images/avatar.png" alt="头像">
        <div class="site-name gt-c-content-color-first">
            lonelyuan&#39;s Blog
        </div>
    </div>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <i class="fas fa-bars gt-c-content-color-first" style="font-size: 18px"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <div class="navbar-nav mr-auto" style="text-align: center">
            
            <div class="nav-item">
                
                <a href="/" class="menu gt-a-link">
                    首页
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/tag/Oi-EjtG-8Z/" class="menu gt-a-link">
                    CTF
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/tag/Lz-SvRH-s/" class="menu gt-a-link">
                    CS
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/archives" class="menu gt-a-link">
                    归档
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/tags" class="menu gt-a-link">
                    标签
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="https://lonelyuan.github.io/post/about" class="menu gt-a-link">
                    关于
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="https://lonelyuan.github.io/friends" class="menu gt-a-link">
                    友链
                </a>
                
            </div>
            
        </div>
        <div style="text-align: center">
            <form id="gridea-search-form" style="position: relative" data-update="1636619068159"
                action="/search/index.html">
                <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="搜索文章" />
                <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
        </div>
    </div>
</nav>
<script>
    /* 移动端导航栏展开/收起切换 */
    document.getElementById('changeNavbar').onclick = function () {
        var element = document.getElementById('navbarSupportedContent');
        if (element.style.display === 'none' || element.style.display === '') {
            element.style.display = 'block';
        } else {
            element.style.display = 'none';
        }
    }
</script>
    <div class="post-container">
        <div class="post-detail gt-bg-theme-color-second">
            <article class="gt-post-content">
                <h2 class="post-title">
                    年轻人的第二个网站 - The Flask Mega Tutorial
                </h2>
                <div class="post-info">
                    <time class="post-time gt-c-content-color-first">
                        · 2021-09-09 ·
                    </time>
                    
                        <a href="https://lonelyuan.github.io/tag/t1NEIiGto/" class="post-tags">
                            # Web
                        </a>
                    
                </div>
                <div class="post-content">
                    <blockquote>
<p>本文为 Flask 框架学习笔记，主要参考了 <a href="https://luhuisicnu.gitbook.io/the-flask-mega-tutorial-zh">The-Flask-Mega-Tutorial</a> 和 《Flask Web开发：基于Python的Web应用开发实战》两本书，并在原项目的基础上拓展。（下文统称这两个资源为“本教程”）<br>
不熟悉 Flask 框架请先阅读<a href="https://dormousehole.readthedocs.io/en/latest/quickstart.html">快速上手 - flask 中文文档</a> 。</p>
<p>这两本书的作者是同一个人，就内容上说后者算是前者的豪华版。本教程的优点是内容全面，从入门到部署一站式服务；缺点是不够深入，且有些过时，书中举例的诸多插件均为作者为了此书而开发的，已经许久不再维护，导致很难在其示例项目上拓展。一看扉页，2015年出版，那没事了。<br>
至于第一个网站？参见<a href="#%E6%88%91%E8%BF%98%E6%B2%A1%E5%86%99%E5%91%A2">#TODO:年轻人的第一个网站</a></p>
</blockquote>
<hr>
<h2 id="0x00-大型项目结构">0x00 大型项目结构</h2>
<p>在大部分面向初学者的 demo 中，应用以简单的项目结构甚至单文件表示。在大型项目中，网站的不同功能被拆分成独立的模块，以方便拓展和维护。一个更通用的 Flask 项目代码架构如下：（仅考虑业务代码）</p>
<pre><code>microblog/ # 根目录
  app/ # 项目源码
    __init__.py # 项目初始化，当该包被import，首先执行__init__.py
    routes.py
    forms.py
    ...
  main.py # 框架入口
  config.py # Config配置类
  .flaskenv
  ...
</code></pre>
<p>根目录下的文件有：</p>
<ul>
<li><code>app/</code>所有网站源代码统一归到app目录下。
<ul>
<li>在<code>app/</code>内部，不同的功能可进一步划分成独立模块，详见[模块化应用](#0x05 模块化应用：功能解耦)一章。</li>
</ul>
</li>
<li><code>main.py</code>: 入口脚本，通过该文件引入app中的代码并生成应用实例（命名随意）</li>
<li><code>.flaskenv</code>: flask环境变量，以配合flask命令。入口脚本被定义为<code>FLASK_APP</code>，执行<code>flask run</code>时将启动该脚本。</li>
<li><code>config.py</code>: 配置脚本，整个项目的配置信息都写在Config类里。与环境变量的区别在于，因为是python脚本，功能更强大，可被任何地方的代码引用。</li>
</ul>
<h2 id="0x01-hello-world模板和视图">0x01 Hello world：模板和视图</h2>
<p>最基本的 web 功能，无非接受请求、返回数据。其中，路由 (route) 用来区分不同的请求，模板 (templates) 用来生成不同的数据。</p>
<h4 id="路由视图">路由/视图</h4>
<p>在非前后端分离的项目中，视图函数直接返回渲染好的网页，由<code>@app.route()</code>修饰后，视图和路由便绑定在一起。<br>
在mvc模型中更像controller控制器的角色，然而在flask生态中更喜欢称为视图函数。</p>
<ul>
<li><code>url_for()</code> 使用URL到视图函数的内部映射关系来生成URL，用来替换硬链接。在业务功能解耦后必须使用这种方式。
<ul>
<li>NOTE：当路由和视图函数名不一致，访问该路由可以正确响应，但是使用<code>url_for()</code>调用该视图时会报错</li>
</ul>
</li>
<li><code>{{% extends &quot;base.html&quot; %}}</code> and <code>{{% include &quot;_post.html&quot; %}}</code> 使用子模板来实现网页公用的部分。如：页眉，页脚，列表项等。
<ul>
<li>模板和 Python 代码的关系有些类似与 JSP 和 Java 代码的关系，但模板语法并不是完整的脚本语言，相较而言限制更多，安全性更好。</li>
</ul>
</li>
</ul>
<h4 id="表单">表单</h4>
<blockquote>
<p>几乎所有成功的框架都有丰富的插件生态。下面引入新功能时，大多借助插件来方便的实现。大多数Flask插件使用<code>flask_&lt;name&gt;</code> 命名约定。</p>
</blockquote>
<p>Flask-WTF插件提供了对Web表单的抽象，只需定义表单类以及设置类属性即可。</p>
<p>模板语法：</p>
<ul>
<li><code>{{ form.&lt;name&gt;.label }}</code>渲染标签</li>
<li><code>{{ form.&lt;name&gt;() }}</code>获取属性值</li>
<li><code>form.hidden_tag()</code>模板参数生成了一个隐藏字段，其中包含一个用于保护表单免受CSRF攻击的token</li>
</ul>
<p>将表单引入模板</p>
<pre><code class="language-python">form = LoginForm() # 生成了一个实例传入模板
return render_template('login.html', title='Sign In', form=form)
</code></pre>
<h4 id="flash-闪现消息">flash 闪现消息</h4>
<p>flash 通过 session 储存，用于显示只出现一次的提示消息。用法：</p>
<ul>
<li>在路由中使用<code>flash()</code>，触发时消息便写入 session 中的 message 列表</li>
<li>在模板中使用<code>get_flashed_messages()</code>，从 session 中读取</li>
</ul>
<h2 id="0x02-数据库-orm">0x02 数据库 ORM</h2>
<p>很久很久以前，web网站和数据库交互还需要写很多很硬的 SQL 语句，效率低且容易出现注入漏洞(SQLi)。现代web开发都使用 ORM 框架简化数据库交互，且基本杜绝了 SQLi 漏洞。</p>
<p>本项目使用如下插件打通数据库：</p>
<ul>
<li>Flask-SQLAlchemy: Python生态最知名的ORM框架</li>
<li>Flask-Migrate: 本教程作者编写的数据库迁移框架</li>
</ul>
<blockquote>
<p>插件首先要注册。统一流程: 初始化app实例，传入插件类作为插件实例的参数</p>
<pre><code class="language-python"># app/__init__.py
app = Flask(__name__) # flask基类
app.config.from_object(Config)
db = SQLAlchemy(app)
migrate = Migrate(app, db)
</code></pre>
</blockquote>
<h3 id="sqlalchemymodel层">SQLalchemy：model层</h3>
<h4 id="模型定义">模型定义</h4>
<p>使用类和类属性代表 table 和 colunm ，便可轻松编写数据模型。SQLalchemy 的概念抽象如下图：<br>
<img src="https://lonelyuan.github.io/post-images/1631793936306.png" alt="" loading="lazy"></p>
<p>Flask-SQLAlchemy 自动设置类名为小写来作为对应表的名称，也可以用<code>__tablename__</code>类属性来定义。</p>
<pre><code class="language-python">class Post(db.Model): # 表
    id = db.Column(db.Integer, primary_key=True) # 列
    ....
</code></pre>
<h4 id="curd基本操作">CURD基本操作</h4>
<p>ORM 框架通常集成了常用操作，但也支持更底层的数据库接口。</p>
<blockquote>
<p>在 Springboot Jpa 中，根据方法名的拼写来写自定义查询，而在 SQLalchemy 中，提供的接口通过链式调用拼接。</p>
</blockquote>
<p>在 SQLalchemy 中，基本操作大都有基于事务 (session) 的和基于查询 (query) 的两种方式。</p>
<ul>
<li>
<p>查</p>
<pre><code class="language-python">session.query(User)
</code></pre>
<p>query方法只有构造一个查询，只有在<code>Query.get()</code>、<code>Query.all()</code>、<code>Query.one()</code>等结束符之后才会执行查询</p>
</li>
<li>
<p>增：</p>
<pre><code class="language-python">db.session.add(user)
db.session.commit()
</code></pre>
</li>
<li>
<p>删</p>
<pre><code class="language-python">session.query(User).delete()
# or
session.delete(session.query(User).get(1))
session.commit()
</code></pre>
</li>
<li>
<p>改</p>
<pre><code class="language-python">query = (session
	.query(User)
	.filter_by(id=1)
	.update({&quot;username&quot;: User.username + &quot;a&quot;}, synchronize_session=False)
)
# or
user = (session.query(User).get(1))
user.password = &quot;zxcv&quot;
session.commit()
</code></pre>
</li>
</ul>
<h3 id="flask-migrate-数据库迁移">Flask-Migrate: 数据库迁移</h3>
<p>配置数据库的初始数据框架，一般写成SQL脚本形式。<br>
migrate 框架直接根据 model 层生成迁移脚本，可以方便的跟踪数据模型的修改和数据库的切换。（这个框架还是本教程作者自己开发的，强）</p>
<p>flask db子命令</p>
<ul>
<li><code>flask db init</code>：初始化，生成migrations目录</li>
<li><code>flask db migrate</code>：生成迁移脚本，修改model后使其生效
<ul>
<li><code>flask db migrate -m &quot;posts table&quot;</code></li>
</ul>
</li>
<li><code>flask db upgrade</code>：应用数据库修改（开发阶段默认使用sqlite数据库</li>
<li><code>flask db downgrade</code>：回滚上次的迁移</li>
</ul>
<h2 id="0x03-开发范式用户系统">0x03 开发范式：用户系统</h2>
<blockquote>
<p>mixin：混入，多重继承的一种形式</p>
</blockquote>
<p>表单和数据库支持分别解决了前端和后端的基本需求，下面可以上线一个基本功能了，用户登录。<br>
所需插件：Flask-Login。</p>
<h4 id="usermixin类">UserMixin类</h4>
<p>UserMixin类集成了login插件要求的用户模型属性，将其混入到 User 模型中，即可用<code>@login_required</code>实现权限控制。</p>
<pre><code>@app.route('/result/', methods=['POST']) # NOTE：有顺序关系，反之则不生效
@login_required 
</code></pre>
<p>用户系统，包括登录、登出、注册几个功能。编写这些功能的步骤其实很类似：</p>
<ul>
<li>设计数据库，在model.py中</li>
<li>设计表单对象，在form.py中</li>
<li>设计页面，在模板.html中</li>
<li>设计视图函数，在routes.py中</li>
</ul>
<p>也对应了mvc框架的设计理念，比如设计表单就有些像 javaweb 中的 DAO 层。但也有区别， Flask 框架更希望业务逻辑写在数据库模型中，而视图函数尽量保持简洁，以方便单元测试。</p>
<h4 id="prg-模式">PRG 模式</h4>
<p>即为 <code>Post/Redirect/Get</code>，其格式大概如下：</p>
<pre><code class="language-python">@bp.route('/some_form', methods=['GET', 'POST'])
def some_form():
    # prepare forms 
    if form.validate_on_submit():
        # submit modification
        return redirect(url_for('main.some_form'))
    elif request.method == 'GET':
    	# GET data
    return render_template('some_form.html', form=form)
</code></pre>
<p>默认情况，提交 POST 请求后，如果直接刷新浏览器，会重新在 POST 一次。使用PRG模式即可解决重复提交表单的问题。</p>
<h2 id="0x04-深入数据库粉丝机制">0x04 深入数据库：粉丝机制</h2>
<h3 id="数据库关系">数据库关系</h3>
<p>要关注别人，就要让数据库记住我关注的人的名字，当然，只记住名字肯定不够，万一改名了呢。因此每个用户都需要有唯一有效的标识（其实更重要的是性能因素）。正因如此，数据库中每个表都要有一个唯一的列，称为<strong>主键</strong>(primary key)。当不同表之间存在关系，一个表要通过主键寻找其他表项，其他表的主键储存在本表中，称为<strong>外键</strong>(foreign key)。外键关联既可以表示一对一的关系，也可以一对多(1-&gt;n)。</p>
<p>SQLalchemy 对关系的定义如下：</p>
<ul>
<li>外键：<code>db.ForeignKey('user.id')</code></li>
<li>关系：<code>db.relationship('Post', backref='author', lazy='dynamic')</code>
<ul>
<li>参数1：所关联的表(n in 1-&gt;n)，这里是模型的变量名</li>
<li>参数2：由 &quot;n&quot; 回调 &quot;1&quot; 的虚拟字段，用法：<code>post.author</code></li>
</ul>
</li>
</ul>
<h3 id="粉丝机制">粉丝机制</h3>
<p>然而，粉丝机制包括关注和被关注。这是一种多对多的关系，于是需要用含有两个外键的<strong>关联表</strong>表示。又因为关注者和被关注者在一个表里（User），这种关系又称为<strong>自引用</strong>。</p>
<h4 id="模型">模型</h4>
<ul>
<li>
<p>关联表只有引用类型，故不需要派生模型类</p>
<pre><code class="language-python">followers = db.Table(
    'followers',
    db.Column('follower_id', db.Integer, db.ForeignKey('user.id')),
    db.Column('followed_id', db.Integer, db.ForeignKey('user.id'))
)
</code></pre>
</li>
<li>
<p>为User添加关系</p>
<pre><code class="language-python">followed = db.relationship('User', # 右侧实体
    secondary=followers, # 指定关联表
    primaryjoin=(followers.c.follower_id == id), # 指定左关系
    secondaryjoin=(followers.c.followed_id == id), # 指定右关系
    backref=db.backref('followers', lazy='dynamic'), lazy='dynamic') # 指定回调
</code></pre>
</li>
</ul>
<h4 id="复杂查询">复杂查询</h4>
<ul>
<li>
<p>查询粉丝列表</p>
<ul>
<li>
<p>SQL 语句：<code>SELECT * FROM user, followers WHERE followers.follower_id = 3 AND followers.followed_id = user.id</code></p>
</li>
<li>
<p>SQLalchemy 接口：<code>user.followers.all()</code></p>
</li>
<li>
<p>实际执行的 SQL 语句：（打印 query 对象得到）</p>
<pre><code>SELECT ,,,  FROM user, followers 
WHERE followers.followed_id = ? AND followers.follower_id = user.id
</code></pre>
</li>
<li>
<p>NOTE：如果方法集成在model里，方法名不要和字段名相同，自己定义的方法会覆盖该字段。</p>
</li>
</ul>
</li>
<li>
<p>查看已关注用户的动态</p>
<ul>
<li>
<p>SQL 语句：<code>SELECT * FROM post JOIN followers on followers.followed_id = post.user_id where followers.follower_id = 2</code></p>
</li>
<li>
<p>SQLalchemy 接口：</p>
</li>
</ul>
<pre><code class="language-sql">Post.query.join(
  followers, (followers.c.followed_id == Post.user_id)).filter(
    followers.c.follower_id == self.id).order_by(
       Post.timestamp.desc())
</code></pre>
<ul>
<li>
<p>实际执行的SQL语句：</p>
<pre><code class="language-sql">SELECT ,,, FROM 
(SELECT ,,,
   FROM post JOIN followers ON followers.followed_id = post.user_id 
   WHERE followers.follower_id = ? 
   UNION SELECT * 
   FROM post 
   WHERE post.user_id = ?
) 
AS anon_1 ORDER BY anon_1.post_timestamp DESC
</code></pre>
</li>
</ul>
</li>
</ul>
<p>由于python的弱类型特征，有时候很难明白函数之间传递的是什么对象。我们从上往下梳理一遍：</p>
<ul>
<li>请求到达路由函数，开始执行查询<code>Post.query.....</code>，此时只是在构造查询，并未取得数据，此时的对象类型：<code>&lt;class 'sqlalchemy.orm.query.Query'&gt;</code></li>
<li>直到<code>get()</code>,<code>all()</code>,<code>paginate().items</code>结束符等出现，查询才被执行，返回数据类型实例，如User。</li>
<li>数据类实例传入模板，并由<code>__str__</code>等方法参与渲染。</li>
</ul>
<h2 id="0x05-网站美化">0x05 网站美化</h2>
<p>本教程提供的flask-bootstrap插件，较为简陋，且该插件年久失修，遂替换之。在此之前，先搞明白目前项目前端的架构</p>
<pre><code>/templates
   auth/
   errors/
   base.html
   _posts.html
   index.html
   ... 
</code></pre>
<p>所有模板都有一个父模版：<code>base.html</code>，其结构如下：</p>
<pre><code class="language-html">{% extends 'bootstrap/base.html' %}
{% block title %}Hallo Wolrd{% endblock %}
{% block head %} ... {% endblock %}
{% block scripts %} ... {% endblock %}
{% block navbar %} ... {% endblock %}
{% block content %}
    ...
    {% block app_content %}{% endblock %}
{% endblock %}
</code></pre>
<p><code>app_content</code>留空，即其余模板均在<code>app_content</code>内填充。</p>
<p>进一步追溯<code>bootstrap/base.html</code>的源码，发现其它 block 诸如<code>navbar</code>也都留空或仅仅配置了 Bootstrap 的 cdn。 由此，只需将<code>base.html</code>迁移即可。</p>
<p>在网上寻找新的UI模板，不要在中文互联网搜索，basically garbage。找到一个 <a href="https://demos.creative-tim.com/material-kit/index.html">Meterial 模板</a> 还算顺眼，遂用之。</p>
<p>不熟悉 Bootstrap 布局的可以使用可视化工具来设计前端，如：http://www.ibootstrap.cn/</p>
<p>对照模板，将<code>base.html</code>掏空，效果如下：</p>
<figure data-type="image" tabindex="1"><img src="https://lonelyuan.github.io/post-images/1631795716824.png" alt="" loading="lazy"></figure>
<p>遇到的bug有：</p>
<ul>
<li>下拉菜单失效：查询得知有可能是bootstrap版本冲突
<ul>
<li>//结果并不是，只是忘记引入js文件而已，我是傻逼。</li>
</ul>
</li>
<li>文件上传按钮消失：本教程中，表单渲染采用<code>wtf.quick_form()</code>，这玩意还是来自<code>bootstrap/wtf.html</code></li>
</ul>
<p>最后决定整个🐏了 Flask-Bootstrap 插件。</p>
<h4 id="富文本编辑器">富文本编辑器</h4>
<p>在《Flask Web开发：基于Python的Web应用开发实战》中提到了markdown编辑器的实现。</p>
<p>需要的包：</p>
<ul>
<li>PageDown: JS 版 Markdown 渲染器，用于客户端预览。</li>
<li>Flask-PageDown: flask 集成插件。该插件需要注册</li>
<li>Markdown: Python 版 Markdown 渲染器，用于服务端渲染。</li>
<li>Bleach: HTML 清理器，保证安全性</li>
</ul>
<p>为了兼顾安全和效率，做法是同时保存 markdown 源文本和 HTML 文件。步骤如下：</p>
<ul>
<li>表单改为 <code>PageDownField</code></li>
<li>模板引入 PageDown 宏，以实现即时预览</li>
<li>为 Post 模型增加字段，并添加 markdown 渲染方法，该方法为类方法，需要<code>@staticmethod</code>修饰</li>
<li>在模型外部监听数据库事件，仅当 markdown 文本出现变动时调用渲染方法。</li>
<li>修改模板以显示服务端返回的 html 文本</li>
</ul>
<p>然而预览器过于简陋，也很难修改。在github仓库上发现该插件也是本教程作者写的，已经很久没有维护。顿时对本书作者有些不满。</p>
<h2 id="0x06-模块化应用功能解耦">0x06 模块化应用：功能解耦</h2>
<p>保持 app 作为全局变量的模式，可能会给后续引入新功能和单元测试带来麻烦。<br>
要适应大型项目需求，需要把网站功能拆分成独立的模块。</p>
<h3 id="blueprint化">Blueprint化</h3>
<p>要实现解耦，一种功能的相关代码可以借助Blueprint归类到一个包里。其文件结构大致如下：</p>
<pre><code class="language-angular2html">app/ 
    some_fuction/                       &lt;-- blueprint package
        __init__.py                     &lt;-- blueprint creation
        ... other code ...
    templates/
        some_fuction/                   &lt;--  templates
    __init__.py                         &lt;-- blueprint registration
</code></pre>
<p>创建blueprint与创建应用非常相似。</p>
<pre><code class="language-python">from flask import Blueprint
bp = Blueprint('func', __name__)
from app.func import Func
</code></pre>
<p>而消灭了<code>app</code>，蓝图内部的引用统一变成了蓝图名。而外部诸如<code>url_for</code>的参数则需要加上<code>包名.</code>做前缀。</p>
<h3 id="应用工厂模式">应用工厂模式</h3>
<p>工厂函数是一个外部函数，在这个函数内部执行插件注册和配置工作，并通过他返回应用实例。</p>
<pre><code class="language-python"># app/__init__.py
db = SQLAlchemy()
# ...
def create_app(config_class=Config):
    app = Flask(__name__)
    app.config.from_object(config_class)
    db.init_app(app)
    # ...
</code></pre>
<p>返回后，flask提供的上下文对象<code>current_app</code>将指向应用实例。详见官方文档：<a href="http://docs.jinkan.org/docs/flask/appcontext.html">应用上下文</a></p>
<h4 id="多线程">多线程</h4>
<p><code>current_app</code>是线程绑定的，若要在诸如邮件服务的位于其他线程的功能调用他，则会发现没有赋值。<br>
需要使用<code>current_app._get_current_object()</code>表达式。</p>
<h4 id="python概念辨析包库插件">Python概念辨析：包，库，插件</h4>
<blockquote>
<p>包 (package) 是指一种代码结构，只要有文件夹和 <code>__init__.py</code> 都是包。<br>
库 (library) 和插件 (plugin) 都是从外部引入的包，区别在于，插件要集成进应用，所以需要注册等步骤；而库更独立，可以随时随地调用</p>
</blockquote>
<h2 id="0x07-开发帮手">0x07 开发帮手</h2>
<p>本节讲解一些杂项。</p>
<h4 id="调试">调试</h4>
<ul>
<li><code>flask shell</code>命令：为避免每次调试都要重新import app，使用上下文调用解释器，用<code>@app.shell_context_processor</code>装饰上下文函数</li>
</ul>
<h4 id="单元测试">单元测试</h4>
<p>unittest 库，详见<a href="">下一篇</a>。</p>
<h4 id="记录日志到文件">记录日志到文件</h4>
<p>logger 库</p>
<pre><code class="language-python">    if not app.debug:
        if not os.path.exists('logs'):
            os.mkdir('logs')
        file_handler = RotatingFileHandler('logs/microblog.log', maxBytes=10240,
                                           backupCount=10)
        file_handler.setFormatter(logging.Formatter(
            '%(asctime)s %(levelname)s: %(message)s [in %(pathname)s:%(lineno)d]'))
        file_handler.setLevel(logging.INFO)
        app.logger.addHandler(file_handler)

        app.logger.setLevel(logging.INFO)
        app.logger.info('Microblog startup')
</code></pre>
<h4 id="requirementtxt">requirement.txt</h4>
<p>装的库太多怎么办？只需要两条命令：</p>
<pre><code class="language-shell">pip freeze &gt; requirements.txt
pip install -r requirements.txt
</code></pre>
<h2 id="0x08-网站上线">0x08 网站上线</h2>
<p>最后简单列出几种网站部署的方法，详情参考本教程或自行搜索。</p>
<h4 id="native模式">native模式</h4>
<ul>
<li>买主机
<ul>
<li>连主机：ssh</li>
</ul>
</li>
<li>买域名
<ul>
<li>配域名</li>
</ul>
</li>
<li>配环境
<ul>
<li>数据库</li>
<li>服务器</li>
<li>其他依赖</li>
</ul>
</li>
<li>持续运维</li>
</ul>
<h4 id="容器化技术docker">容器化技术：docker</h4>
<ul>
<li>写dockerfile</li>
<li>docker-compose up --build -d</li>
</ul>
<h4 id="云技术paas">云技术：PaaS</h4>
<ul>
<li>注册云平台账户</li>
<li>写Procfile</li>
<li>git push</li>
</ul>

                </div>
            </article>
        </div>

        
            <div class="next-post">
                <div class="next gt-c-content-color-first">下一篇</div>
                <a href="https://lonelyuan.github.io/post/awd-da-pian/" class="post-title gt-a-link">
                    CISCN2021华东百赛区分区选拔赛AWD复盘
                </a>
            </div>
        

        

        
            
                <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js"></script>
<script>
    // md5.min.js
    !function(n){
        "use strict";
        function d(n,t){var r=(65535&n)+(65535&t);return(n>>16)+(t>>16)+(r>>16)<<16|65535&r}
        function f(n,t,r,e,o,u){return d((c=d(d(t,n),d(e,u)))<<(f=o)|c>>>32-f,r);var c,f}
        function l(n,t,r,e,o,u,c){return f(t&r|~t&e,n,t,o,u,c)}
        function v(n,t,r,e,o,u,c){return f(t&e|r&~e,n,t,o,u,c)}
        function g(n,t,r,e,o,u,c){return f(t^r^e,n,t,o,u,c)}
        function m(n,t,r,e,o,u,c){return f(r^(t|~e),n,t,o,u,c)}
        function i(n,t){var r,e,o,u,c;n[t>>5]|=128<<t%32,n[14+(t+64>>>9<<4)]=t;var f=1732584193,i=-271733879,a=-1732584194,h=271733878;for(r=0;r<n.length;r+=16)f=l(e=f,o=i,u=a,c=h,n[r],7,-680876936),h=l(h,f,i,a,n[r+1],12,-389564586),a=l(a,h,f,i,n[r+2],17,606105819),i=l(i,a,h,f,n[r+3],22,-1044525330),f=l(f,i,a,h,n[r+4],7,-176418897),h=l(h,f,i,a,n[r+5],12,1200080426),a=l(a,h,f,i,n[r+6],17,-1473231341),i=l(i,a,h,f,n[r+7],22,-45705983),f=l(f,i,a,h,n[r+8],7,1770035416),h=l(h,f,i,a,n[r+9],12,-1958414417),a=l(a,h,f,i,n[r+10],17,-42063),i=l(i,a,h,f,n[r+11],22,-1990404162),f=l(f,i,a,h,n[r+12],7,1804603682),h=l(h,f,i,a,n[r+13],12,-40341101),a=l(a,h,f,i,n[r+14],17,-1502002290),f=v(f,i=l(i,a,h,f,n[r+15],22,1236535329),a,h,n[r+1],5,-165796510),h=v(h,f,i,a,n[r+6],9,-1069501632),a=v(a,h,f,i,n[r+11],14,643717713),i=v(i,a,h,f,n[r],20,-373897302),f=v(f,i,a,h,n[r+5],5,-701558691),h=v(h,f,i,a,n[r+10],9,38016083),a=v(a,h,f,i,n[r+15],14,-660478335),i=v(i,a,h,f,n[r+4],20,-405537848),f=v(f,i,a,h,n[r+9],5,568446438),h=v(h,f,i,a,n[r+14],9,-1019803690),a=v(a,h,f,i,n[r+3],14,-187363961),i=v(i,a,h,f,n[r+8],20,1163531501),f=v(f,i,a,h,n[r+13],5,-1444681467),h=v(h,f,i,a,n[r+2],9,-51403784),a=v(a,h,f,i,n[r+7],14,1735328473),f=g(f,i=v(i,a,h,f,n[r+12],20,-1926607734),a,h,n[r+5],4,-378558),h=g(h,f,i,a,n[r+8],11,-2022574463),a=g(a,h,f,i,n[r+11],16,1839030562),i=g(i,a,h,f,n[r+14],23,-35309556),f=g(f,i,a,h,n[r+1],4,-1530992060),h=g(h,f,i,a,n[r+4],11,1272893353),a=g(a,h,f,i,n[r+7],16,-155497632),i=g(i,a,h,f,n[r+10],23,-1094730640),f=g(f,i,a,h,n[r+13],4,681279174),h=g(h,f,i,a,n[r],11,-358537222),a=g(a,h,f,i,n[r+3],16,-722521979),i=g(i,a,h,f,n[r+6],23,76029189),f=g(f,i,a,h,n[r+9],4,-640364487),h=g(h,f,i,a,n[r+12],11,-421815835),a=g(a,h,f,i,n[r+15],16,530742520),f=m(f,i=g(i,a,h,f,n[r+2],23,-995338651),a,h,n[r],6,-198630844),h=m(h,f,i,a,n[r+7],10,1126891415),a=m(a,h,f,i,n[r+14],15,-1416354905),i=m(i,a,h,f,n[r+5],21,-57434055),f=m(f,i,a,h,n[r+12],6,1700485571),h=m(h,f,i,a,n[r+3],10,-1894986606),a=m(a,h,f,i,n[r+10],15,-1051523),i=m(i,a,h,f,n[r+1],21,-2054922799),f=m(f,i,a,h,n[r+8],6,1873313359),h=m(h,f,i,a,n[r+15],10,-30611744),a=m(a,h,f,i,n[r+6],15,-1560198380),i=m(i,a,h,f,n[r+13],21,1309151649),f=m(f,i,a,h,n[r+4],6,-145523070),h=m(h,f,i,a,n[r+11],10,-1120210379),a=m(a,h,f,i,n[r+2],15,718787259),i=m(i,a,h,f,n[r+9],21,-343485551),f=d(f,e),i=d(i,o),a=d(a,u),h=d(h,c);return[f,i,a,h]}
        function a(n){var t,r="",e=32*n.length;for(t=0;t<e;t+=8)r+=String.fromCharCode(n[t>>5]>>>t%32&255);return r}
        function h(n){var t,r=[];for(r[(n.length>>2)-1]=void 0,t=0;t<r.length;t+=1)r[t]=0;var e=8*n.length;for(t=0;t<e;t+=8)r[t>>5]|=(255&n.charCodeAt(t/8))<<t%32;return r}
        function e(n){var t,r,e="0123456789abcdef",o="";for(r=0;r<n.length;r+=1)t=n.charCodeAt(r),o+=e.charAt(t>>>4&15)+e.charAt(15&t);return o}
        function r(n){return unescape(encodeURIComponent(n))}
        function o(n){return a(i(h(t=r(n)),8*t.length));var t}
        function u(n,t){return function(n,t){var r,e,o=h(n),u=[],c=[];for(u[15]=c[15]=void 0,16<o.length&&(o=i(o,8*n.length)),r=0;r<16;r+=1)u[r]=909522486^o[r],c[r]=1549556828^o[r];return e=i(u.concat(h(t)),512+8*t.length),a(i(c.concat(e),640))}(r(n),r(t))}
        function t(n,t,r){return t?r?u(t,n):e(u(t,n)):r?o(n):e(o(n))}
        "function"==typeof define&&define.amd?define(function(){return t}):"object"==typeof module&&module.exports?module.exports=t:n.md5=t;
    }(this);
</script>


<div id="gitalk-container"></div>

<script>

  var gitalk = new Gitalk({
    clientID: '51da5c60f4f56c7257ec',
    clientSecret: 'c6208164907a36b5b54077802ac3319a9dc833f9',
    repo: 'gitalk_comments',
    owner: 'lonelyuan',
    admin: ['lonelyuan'],
    id: md5(location.pathname),      // Ensure uniqueness and length less than 50
    distractionFreeMode: false       // Facebook-like distraction free mode
  })

  gitalk.render('gitalk-container')

</script>

            

            
        

        

        <div class="site-footer gt-c-content-color-first">
    <div class="slogan gt-c-content-color-first"> >> 不要恐慌 | Don't Panic </div>
    <div class="social-container">
        
            
                <a href="https://github.com/lonelyuan" target="_blank">
                    <i class="fab fa-github gt-c-content-color-first"></i>
                </a>
            
        
            
                <a href="https://twitter.com/FTrumpyeah" target="_blank">
                    <i class="fab fa-twitter gt-c-content-color-first"></i>
                </a>
            
        
            
        
            
        
            
        
            
        
    </div>
    <div class="footer-info">
        
    </div>
    <div>
        Theme by <a href="https://imhanjie.com/" target="_blank">imhanjie</a>, Powered by <a
                href="https://github.com/getgridea/gridea" target="_blank">Gridea | <a href="https://lonelyuan.github.io/atom.xml" target="_blank">RSS</a></a>
    </div>
</div>

<script>
  hljs.initHighlightingOnLoad()
</script>

    </div>
</div>
</body>
</html>
